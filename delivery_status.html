<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Delivery Status</title>

<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

<style>
.header { background: #ffca1d; position:sticky; top:0; z-index:100; }
.order-row{display:flex; justify-content:space-between; width:100%; align-items:center;}
.route-badge{background: #ffca1d; color:rgb(0, 0, 0); padding:8px; border-radius:8px; font-size:16px; margin-bottom:15px;}
.status-badge{position:absolute; top:8px; right: 12px; padding:4px 6px; border-radius:4px; font-size:11px;}
.amount-badge{background:#198754;color:white;padding:2px 5px;border-radius:4px;font-size:10px;margin-top:3px;}
/* Updated for edit button positioning - moved upward */
.order-actions {
  position: absolute;
  bottom: 6px;
  right: 8px;
}

.status-badge {
  position: absolute;
  top: 10px;
  right: 10px;
  padding: 5px 12px;
  font-size: 14px;
  border-radius: 12px;
  font-weight: 600;
  color: white;
}

.status-green {
  background-color: #28a745 !important;  /* Green */
}

.status-red {
  background-color: #dc3545 !important;  /* Red */
}


.small-action-btn {
  width: 32px;
  height: 32px;
  display: flex;
  align-items: center;
  justify-content: center;
  font-size: 13px;
  border-radius: 6px;
}

</style>
</head>

<body>

<!-- HEADER -->
<div class="header p-2 d-flex align-items-center shadow-sm">
<button id="backButton" class="btn text-black"><i class="fa-solid fa-arrow-left"></i></button>
<h5 class="ms-2 text-black fw-bold mb-0">Delivery Status</h5>
</div>

<main class="container mt-3">
<div id="routeBadge"></div>
<div id="orderList"></div>

<div id="loadingSpinner" class="text-center mt-3">
<div class="spinner-border text-primary"></div>
<p>Loading Orders...</p>
</div>

<div id="noOrdersMessage" class="text-center text-muted mt-4" style="display:none;">
<i class="fa-solid fa-box-open fa-3x"></i>
<p>No orders found.</p>
</div>

<div id="paginationContainer" class="d-none text-center mt-3">
<button id="prevBtn" class="btn btn-outline-dark btn-sm">â—€</button>
<span id="pageInfo" class="px-2"></span>
<button id="nextBtn" class="btn btn-outline-dark btn-sm">â–¶</button>
</div>
</main>

<!-- ROUTE SELECT MODAL -->
<div class="modal fade" id="routeModal" tabindex="-1">
<div class="modal-dialog">
<div class="modal-content">
<div class="modal-header"><h5>Select Route</h5></div>
<div class="modal-body">

<label class="form-label fw-bold">Choose Route:</label>
<select id="routeDropdown" class="form-control">
<option value="">-- Select Route --</option>
</select>

</div>
<div class="modal-footer">
<button class="btn btn-secondary" id="cancelBtn">Close</button>
<button class="btn btn-primary" id="applyRouteBtn">Apply Route</button>
</div>
</div>
</div>
</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>

<script>
const APP_ID = "Mzk-";
let selectedRouteId = "";
let selectedRoute = "";
let allOrders = [];
let currentPage = 1;
const PER_PAGE = 10;

/****** OPEN MODAL ******/
document.addEventListener("DOMContentLoaded", async () => {
  new bootstrap.Modal(document.getElementById("routeModal")).show();
  loadRoutes();
});
console.log("Delivery Status Page Loaded");
/****** LOAD ROUTES ******/
fetch("https://www.loginlogistics.in/main/driverapp/get_my_delivery_routes.php", {
  method:"POST",
  headers:{ "Content-Type":"application/json" },
  body: JSON.stringify({ app_id:"Mzk-" })
})
.then(r=>r.json()).then(console.log);

async function loadRoutes() {
  try {
    const res = await fetch("https://www.loginlogistics.in/main/driverapp/get_my_delivery_routes.php", {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({ app_id: APP_ID })
    });

    const data = await res.json();
    console.log("ðŸ“¥ Route Response:", data);

    let routes = data.routedet; // Correct array

    if (!routes || routes.length === 0) {
      alert("âš  No routes found");
      return;
    }

    const dropdown = document.getElementById("routeDropdown");

    routes.forEach(r => {
      const option = document.createElement("option");
      option.value = r.rtid;      // Route ID
      option.textContent = r.rt_name;  // Route Name
      dropdown.appendChild(option);
    });

  } catch (err) {
    console.error("Route Fetch Error:", err);
    alert("Failed to load routes");
  }
}
document.getElementById("backButton").addEventListener("click",()=>{ 
  window.location.href="index.html";
});

document.getElementById("cancelBtn").addEventListener("click", () => {
  window.location.href = "index.html";
});


/****** APPLY SELECTED ROUTE ******/
document.getElementById("applyRouteBtn").addEventListener("click", () => {
  selectedRouteId = document.getElementById("routeDropdown").value;
  selectedRoute   = document.getElementById("routeDropdown")
                   .options[document.getElementById("routeDropdown").selectedIndex].text;

  if(!selectedRouteId){
    alert("Please choose a route");
    return;
  }

  document.getElementById("routeBadge").innerHTML =
    `<div class='route-badge'>Route: ${selectedRoute}</div>`;

  document.activeElement.blur();  // <<< fix
  bootstrap.Modal.getInstance(document.getElementById("routeModal")).hide();
  loadOrders();
});


/****** LOAD ORDERS ******/
async function loadOrders(){
  document.getElementById("loadingSpinner").style.display="block";
  document.getElementById("orderList").innerHTML="";
  document.getElementById("noOrdersMessage").style.display="none";

  const res = await fetch("https://www.loginlogistics.in/main/driverapp/delivery-orders.php",{
    method:"POST",
    headers:{ "Content-Type":"application/json" },
    body: JSON.stringify({ app_id: APP_ID, route_id: selectedRouteId })
  });

  const data = await res.json();
  allOrders = data.delOrders;

  if(data.result==="1" && allOrders.length > 0){
    renderOrders();
    setupPagination();
  } else {
    document.getElementById("noOrdersMessage").style.display="block";
  }

  document.getElementById("loadingSpinner").style.display="none";
}

/****** RENDER ORDERS ******/
function renderOrders(){
  let start = (currentPage - 1) * PER_PAGE;
  let pageOrders = allOrders.slice(start, start + PER_PAGE);
  let html = "";

  pageOrders.forEach(order =>{
    html += `
<div class="card p-3 mb-2 position-relative">
  <span class="status-badge ${order.courier_status.toLowerCase()==='delivered' ? 'status-green' : 'status-red'}">
    ${order.courier_status}
  </span>




<div class="order-row">
<div class="details-left">
<strong>POD:</strong> ${order.pod_no}<br>
<strong>Consignee:</strong> ${order.consignee}<br>
<strong>Consignor:</strong> ${order.consignor}<br>
<span class="amount-badge"><i class="fa-solid fa-rupee-sign"></i> ${order.total_amount}</span>
</div>

<div class="details-right">
<strong>Qty:</strong> ${order.total_qty}<br>
<strong>Stop:</strong> ${order.stop}<br>
</div>
</div>

<!-- EDIT BUTTON ADDED HERE -->
<div class="order-actions">
<button class="btn btn-warning small-action-btn" onclick="editOrder('${order.ord_id}')">
<i class="fa-solid fa-pen"></i>
</button>
</div>
</div>`;
  });

  document.getElementById("orderList").innerHTML = html;
}

/****** PAGINATION ******/
function setupPagination(){
  const totalPages = Math.ceil(allOrders.length / PER_PAGE);
  document.getElementById("paginationContainer").classList.remove("d-none");
  document.getElementById("pageInfo").innerText = `${currentPage}/${totalPages}`;

  document.getElementById("prevBtn").onclick = () => {
    if(currentPage > 1){ currentPage--; renderOrders(); setupPagination(); }
  };

  document.getElementById("nextBtn").onclick = () => {
    if(currentPage < totalPages){ currentPage++; renderOrders(); setupPagination(); }
  };
}

/****** EDIT ORDER - REDIRECT TO EDIT_DELIVERY.HTML ******/
function editOrder(id){
  localStorage.setItem("selectedOrderId", id);
  window.location.href = "edit_delivery.html";
}

/****** VIEW ORDER ******/
function viewOrder(id){
  localStorage.setItem("selectedOrderId", id);
  window.location.href="view_order.html";
}
</script>
</body>
</html>