<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>View Orders</title>

  <!-- âœ… Bootstrap CSS -->
  <link href="../bootstrap-5.3.8-dist/bootstrap-5.3.8-dist/css/bootstrap.min.css" rel="stylesheet" />

  <!-- âœ… FontAwesome -->
  <link rel="stylesheet" href="../fontawesome-free-7.1.0-web/fontawesome-free-7.1.0-web/css/all.min.css" />
  <link rel="stylesheet" href="css/view_order.css" />

  <style>
    .loading-spinner {
      display: none;
      text-align: center;
      padding: 20px;
    }
    .no-orders {
      text-align: center;
      padding: 40px;
      color: #6c757d;
    }
    .pagination-container {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin: 20px 0;
      padding: 15px;
      background-color: #f8f9fa;
      border-radius: 8px;
      position: fixed;
      bottom: 0;
      left: 0;
      right: 0;
      z-index: 1000;
      box-shadow: 0 -2px 10px rgba(0,0,0,0.1);
    }
    .page-info {
      font-weight: 500;
      color: #495057;
      text-align: center;
    }
    .pagination-buttons {
      display: flex;
      gap: 10px;
    }
    .payment-status {
      font-weight: 500;
    }
    .payment-paid {
      color: #28a745;
    }
    .payment-to-pay {
      color: #dc3545;
    }
    .payment-unknown {
      color: #6c757d;
    }
    .card-body p {
      margin-bottom: 0.4rem;
    }
    .orders-count {
      font-size: 0.9rem;
      color: #6c757d;
      margin-top: 5px;
    }
    .main-content {
      margin-bottom: 100px; /* Space for fixed pagination */
    }
  </style>
</head>

<body>
  <!-- âœ… Header Section -->
  <div class="header bg-orange shadow-sm">
    <div class="d-flex align-items-center p-3">
      <button id="backbtn" class="btn btn-link text-dark">
        <i class="fa-solid fa-arrow-left fa-lg"></i>
      </button>
      <h5 class="mb-0 fw-bold">View Orders</h5>
    </div>
  </div>

  <!-- âœ… Main Content -->
  <main class="container mt-3 mb-5 main-content">
    <!-- Orders List -->
    <div id="orderList"></div>

    <!-- Loading Spinner -->
    <div class="loading-spinner" id="loadingSpinner">
      <div class="spinner-border text-primary" role="status">
        <span class="visually-hidden">Loading...</span>
      </div>
      <p class="mt-2">Loading orders...</p>
    </div>

    <!-- No Orders Message -->
    <div class="no-orders" id="noOrdersMessage" style="display: none;">
      <i class="fa-solid fa-box-open fa-3x mb-3"></i>
      <h5>No Orders Found</h5>
      <p>There are no orders to display at the moment.</p>
    </div>
  </main>

  <!-- Pagination Footer -->
  <div class="pagination-container" id="paginationContainer" style="display: none;">
    <div class="pagination-buttons">
      <button class="btn btn-outline-primary" id="prevBtn">
        <i class="fa-solid fa-chevron-left me-1"></i> Previous
      </button>
    </div>

    <div class="page-info" id="pageInfo"></div>

    <div class="pagination-buttons">
      <button class="btn btn-outline-primary" id="nextBtn">
        Next <i class="fa-solid fa-chevron-right ms-1"></i>
      </button>
    </div>
  </div>

  <!-- ðŸ—‘ Delete Reason Modal -->
  <div class="modal fade" id="deleteModal" tabindex="-1" aria-labelledby="deleteModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title">Reason for Deletion</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
        </div>
        <div class="modal-body">
          <textarea id="deleteReason" class="form-control" rows="3" placeholder="Enter reason..."></textarea>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-danger" id="confirmDeleteBtn">Delete</button>
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
        </div>
      </div>
    </div>
  </div>

  <!-- âœï¸ Edit Order Modal -->
  <div class="modal fade" id="editModal" tabindex="-1" aria-labelledby="editModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title">Edit Order</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
        </div>
        <div class="modal-body">
          <form id="editForm">
            <div class="mb-3">
              <label class="form-label">POD Number</label>
              <input type="text" class="form-control" id="editPodNo" required>
            </div>
            <div class="mb-3">
              <label class="form-label">Consigner</label>
              <input type="text" class="form-control" id="editConsigner" required>
            </div>
            <div class="mb-3">
              <label class="form-label">Consignee</label>
              <input type="text" class="form-control" id="editConsignee" required>
            </div>
            <div class="mb-3">
              <label class="form-label">Stop</label>
              <input type="text" class="form-control" id="editStop">
            </div>
            <div class="mb-3">
              <label class="form-label">Route</label>
              <input type="text" class="form-control" id="editRoute">
            </div>
            <div class="mb-3">
              <label class="form-label">Date</label>
              <input type="date" class="form-control" id="editDate" required>
            </div>
            <div class="mb-3">
              <label class="form-label">Payment Status</label>
              <select class="form-control" id="editPaymentStatus">
                <option value="paid">Paid</option>
                <option value="to-pay">To Pay</option>
                <option value="unknown">Unknown</option>
              </select>
            </div>
          </form>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
          <button type="button" class="btn btn-primary" id="saveEditBtn">Save Changes</button>
        </div>
      </div>
    </div>
  </div>

  <!-- âœ… Bootstrap JS -->
  <script src="../bootstrap-5.3.8-dist/bootstrap-5.3.8-dist/js/bootstrap.bundle.min.js"></script>

  <script>
    // Configuration - 15 ORDERS PER PAGE
    const ORDERS_PER_PAGE = 15;
    let currentPage = 1;
    let totalPages = 0;
    let allOrders = [];
    let isLoading = false;

    // DOM Elements
    const orderList = document.getElementById("orderList");
    const loadingSpinner = document.getElementById("loadingSpinner");
    const paginationContainer = document.getElementById("paginationContainer");
    const pageInfo = document.getElementById("pageInfo");
    const prevBtn = document.getElementById("prevBtn");
    const nextBtn = document.getElementById("nextBtn");
    const noOrdersMessage = document.getElementById("noOrdersMessage");
    const deleteModal = new bootstrap.Modal(document.getElementById("deleteModal"));
    const editModal = new bootstrap.Modal(document.getElementById("editModal"));

    let orderToDelete = null;
    let orderToEdit = null;

    // Set app_id
    localStorage.setItem('app_id', 'Mzk-');

    // ðŸ”™ Back button
    document.getElementById('backbtn').addEventListener('click', function() {
      window.location.href = 'index.html';
    });

    // Navigation buttons
    prevBtn.addEventListener('click', goToPreviousPage);
    nextBtn.addEventListener('click', goToNextPage);

    // Initialize
    document.addEventListener('DOMContentLoaded', function() {
      loadOrders();
    });

    // ============================
    // API: loadOrders (POST + app_id header)
    // ============================
    async function loadOrders() {
      try {
        showLoading(true);

        const appId = localStorage.getItem('app_id');
        if (!appId) {
          throw new Error('App ID not found in localStorage. Please set app_id first.');
        }

        const response = await fetch('https://www.loginlogistics.in/main/driverapp/my-orders.php', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
          },
          body: JSON.stringify({'app_id': "Mzk-"})
        });
        
        console.log('Raw API Response Status:', response.status);
        
        if (!response.ok) {
          let text = await response.text().catch(() => '');
          throw new Error(`HTTP error: ${response.status} ${response.statusText} ${text ? '- ' + text : ''}`);
        }

        let data;
        try {
          data = await response.json();
        } catch (e) {
          const text = await response.text();
          console.warn('Server returned non-JSON response:', text);
          throw new Error('Server returned non-JSON response.');
        }

        console.log('API Data received:', data);
        allOrders = transformApiResponse(data);
        console.log('Transformed orders:', allOrders);

        // Debug info
        console.log('=== DEBUG INFO ===');
        console.log('Total orders from API:', allOrders.length);
        console.log('Orders per page:', ORDERS_PER_PAGE);
        console.log('Total pages:', Math.ceil(allOrders.length / ORDERS_PER_PAGE));
        console.log('First few orders:', allOrders.slice(0, 3));

        // DISPLAY THE DATA
        totalPages = Math.ceil(allOrders.length / ORDERS_PER_PAGE);
        if (allOrders.length === 0) {
          showNoOrdersMessage();
        } else {
          renderCurrentPage();
          updatePagination();
        }

      } catch (error) {
        console.error('Error loading orders:', error);
        alert('Error loading orders: ' + error.message);
        showNoOrdersMessage();
      } finally {
        showLoading(false);
      }
    }

    // ============================
    // DATA TRANSFORMATION
    // ============================
    function transformApiResponse(apiData) {
      if (!apiData) {
        console.log('No API data received');
        return [];
      }

      console.log('API Data for transformation:', apiData);

      // Handle your exact JSON format: { "allOrders": [{...}, {...}] }
      let list = null;
      if (apiData.allOrders && Array.isArray(apiData.allOrders)) {
        list = apiData.allOrders;
      } else if (Array.isArray(apiData)) {
        list = apiData;
      } else if (Array.isArray(apiData.orders)) {
        list = apiData.orders;
      } else if (Array.isArray(apiData.data)) {
        list = apiData.data;
      }

      if (!list) {
        console.log('No orders list found. Available keys:', Object.keys(apiData));
        return [];
      }

      console.log('Orders list found, count:', list.length);

      // Transform each order using your exact field names
      return list.map(order => {
        console.log('Processing order:', order);
        
        // Determine payment status based on your exact fields
        let paymentStatus = 'unknown';
        if (order.topay === 'yes') {
          paymentStatus = 'to-pay';
        } else if (order.paid_order === 'yes') {
          paymentStatus = 'paid';
        } else if (order.topay === 'no' && order.paid_order === 'no') {
          paymentStatus = 'to-pay';
        }

        return {
          id: order.ord_id || '', // "NQ--"
          podNo: order.pod_no || '', // "22810-212111112025202520252025/1"
          consigner: order.consignor || '', // "Green Dent"
          consignee: order.consignee || '', // "Dr Bipin Ashokan"
          stop: order.stop || '', // "Ayikkarapadi"
          route: order.route || '', // "CALICUT"
          date: order.add_date || '', // "21/11/2025"
          paymentStatus: paymentStatus
        };
      });
    }

    // ============================
    // Render / Pagination
    // ============================
    function renderCurrentPage() {
      const startIndex = (currentPage - 1) * ORDERS_PER_PAGE;
      const endIndex = startIndex + ORDERS_PER_PAGE;
      const currentOrders = allOrders.slice(startIndex, endIndex);

      if (currentOrders.length === 0) {
        orderList.innerHTML = '<div class="no-orders">No orders on this page</div>';
        return;
      }

      let html = '';
      currentOrders.forEach((order, index) => {
        const paymentStatusClass = getPaymentStatusClass(order.paymentStatus);
        const paymentStatusText = getPaymentStatusText(order.paymentStatus);
        const globalIndex = (currentPage - 1) * ORDERS_PER_PAGE + index;

        html += `
          <div class="card shadow-sm mb-3">
            <div class="card-body">
              <div class="d-flex justify-content-between align-items-center mb-2">
                <h6 class="mb-0">POD No: <strong>#${escapeHtml(order.podNo)}</strong></h6>
                <span class="payment-status ${paymentStatusClass}">${escapeHtml(paymentStatusText)}</span>
              </div>

              ${order.consigner ? `<p><strong>Consigner:</strong> ${escapeHtml(order.consigner)}</p>` : ''}
              ${order.consignee ? `<p><strong>Consignee:</strong> ${escapeHtml(order.consignee)}</p>` : ''}
              ${order.stop ? `<p><strong>Stop:</strong> ${escapeHtml(order.stop)}</p>` : ''}
              ${order.route ? `<p><strong>Route:</strong> ${escapeHtml(order.route)}</p>` : ''}

              <div class="btn-group mt-2">
                <button class="btn btn-primary btn-sm btn-view" onclick="viewOrderDetails('${encodeURIComponent(order.id)}')">
                  <i class="fa-solid fa-eye"></i> View
                </button>
                <button class="btn btn-warning btn-sm btn-edit" data-index="${globalIndex}">
                  <i class="fa-solid fa-pencil"></i> Edit
                </button>
                <button class="btn btn-danger btn-sm btn-delete" data-index="${globalIndex}">
                  <i class="fa-solid fa-trash"></i> Delete
                </button>
              </div>

              <div class="text-muted small mt-2">
                <i class="fa-solid fa-calendar me-1"></i> ${formatDate(order.date)}
              </div>
            </div>
          </div>
        `;
      });

      orderList.innerHTML = html;
      attachEventListeners();
    }

    function goToPreviousPage() {
      if (currentPage > 1) {
        currentPage--;
        renderCurrentPage();
        updatePagination();
        scrollToTop();
      }
    }

    function goToNextPage() {
      if (currentPage < totalPages) {
        currentPage++;
        renderCurrentPage();
        updatePagination();
        scrollToTop();
      }
    }

    function updatePagination() {
      const startOrder = (currentPage - 1) * ORDERS_PER_PAGE + 1;
      const endOrder = Math.min(currentPage * ORDERS_PER_PAGE, allOrders.length);

      pageInfo.innerHTML = `
        <strong>Page ${currentPage} of ${totalPages}</strong>
        <div class="orders-count">Showing orders ${startOrder}-${endOrder} of ${allOrders.length} total orders</div>
      `;

      prevBtn.disabled = currentPage === 1;
      nextBtn.disabled = currentPage === totalPages;

      // Show pagination only if there are multiple pages
      paginationContainer.style.display = totalPages > 1 ? 'flex' : 'none';
    }

    function scrollToTop() {
      window.scrollTo({ top: 0, behavior: 'smooth' });
    }

    function viewOrderDetails(orderId) {
      window.location.href = `view.html?orderId=${orderId}`;
    }

    // ============================
    // Event listeners: Edit / Delete
    // ============================
    function attachEventListeners() {
      // Delete buttons
      document.querySelectorAll(".btn-delete").forEach(btn => {
        btn.removeEventListener('click', onDeleteClick);
        btn.addEventListener("click", onDeleteClick);
      });

      // Edit buttons
      document.querySelectorAll(".btn-edit").forEach(btn => {
        btn.removeEventListener('click', onEditClick);
        btn.addEventListener("click", onEditClick);
      });
    }

    function onDeleteClick(e) {
      const index = parseInt(e.target.closest("button").dataset.index, 10);
      orderToDelete = allOrders[index];
      document.getElementById("deleteReason").value = "";
      deleteModal.show();
    }

    function onEditClick(e) {
      const index = parseInt(e.target.closest("button").dataset.index, 10);
      orderToEdit = allOrders[index];
      document.getElementById("editPodNo").value = orderToEdit.podNo || '';
      document.getElementById("editConsigner").value = orderToEdit.consigner || '';
      document.getElementById("editConsignee").value = orderToEdit.consignee || '';
      document.getElementById("editStop").value = orderToEdit.stop || '';
      document.getElementById("editRoute").value = orderToEdit.route || '';
      document.getElementById("editDate").value = formatDateForInput(orderToEdit.date);
      document.getElementById("editPaymentStatus").value = orderToEdit.paymentStatus || 'unknown';
      editModal.show();
    }

    // ============================
    // Payment status helpers
    // ============================
    function getPaymentStatusClass(status) {
      if (!status) return "payment-unknown";
      switch (status.toString().toLowerCase()) {
        case "paid":
          return "payment-paid";
        case "to-pay":
        case "topay":
        case "to pay":
          return "payment-to-pay";
        default:
          return "payment-unknown";
      }
    }

    function getPaymentStatusText(status) {
      if (!status) return "Unknown";
      switch (status.toString().toLowerCase()) {
        case "paid":
          return "Paid";
        case "to-pay":
        case "topay":
        case "to pay":
          return "To Pay";
        default:
          return "Unknown";
      }
    }

    // ============================
    // Date helpers - FIXED VERSION
    // ============================
    function formatDate(dateString) {
      if (!dateString) return 'N/A';
      try {
        // Handle DD/MM/YYYY format from your API
        if (dateString.includes('/')) {
          const parts = dateString.split('/');
          if (parts.length === 3) {
            const date = new Date(parts[2], parts[1] - 1, parts[0]);
            if (!isNaN(date.getTime())) {
              return date.toLocaleDateString('en-US', {
                year: 'numeric',
                month: 'short',
                day: 'numeric'
              });
            }
          }
        }
        
        // Try standard date parsing
        const date = new Date(dateString);
        if (!isNaN(date.getTime())) {
          return date.toLocaleDateString('en-US', {
            year: 'numeric',
            month: 'short',
            day: 'numeric'
          });
        }
        
        return dateString;
      } catch (e) {
        return dateString;
      }
    }

    function formatDateForInput(dateString) {
      if (!dateString) return '';
      try {
        // Handle DD/MM/YYYY format from your API
        if (dateString.includes('/')) {
          const parts = dateString.split('/');
          if (parts.length === 3) {
            return `${parts[2]}-${parts[1].padStart(2, '0')}-${parts[0].padStart(2, '0')}`;
          }
        }
        
        const date = new Date(dateString);
        if (!isNaN(date.getTime())) {
          return date.toISOString().split('T')[0];
        }
        
        return '';
      } catch (e) {
        return '';
      }
    }

    // ============================
    // Show / hide loading & empty
    // ============================
    function showLoading(show) {
      isLoading = show;
      loadingSpinner.style.display = show ? 'block' : 'none';
      prevBtn.disabled = show;
      nextBtn.disabled = show;
    }

    function showNoOrdersMessage() {
      noOrdersMessage.style.display = 'block';
      paginationContainer.style.display = 'none';
      orderList.innerHTML = '';
    }

    // ============================
    // Confirm Delete (POST + app_id header)
    // ============================
    document.getElementById("confirmDeleteBtn").addEventListener("click", async () => {
      const reason = document.getElementById("deleteReason").value.trim();
      if (!reason) return alert("Please provide a reason.");

      try {
        const appId = localStorage.getItem('app_id');
        if (!appId) throw new Error('app_id missing in localStorage');

        const response = await fetch('https://www.loginlogistics.in/main/driverapp/delete-order.php', {
          method: 'POST',
          mode: 'cors',
          headers: {
            'Content-Type': 'application/json',
            'app_id': "Mzk-"
          },
          body: JSON.stringify({
            orderId: orderToDelete.id,
            reason: reason
          })
        });

        if (!response.ok) {
          const text = await response.text().catch(() => '');
          throw new Error(`HTTP error: ${response.status} ${text}`);
        }

        const result = await response.json().catch(() => null);
        if (result && result.success === true) {
          allOrders = allOrders.filter(order => order.id !== orderToDelete.id);
          totalPages = Math.ceil(allOrders.length / ORDERS_PER_PAGE);
          if (currentPage > totalPages && totalPages > 0) currentPage = totalPages;
          if (allOrders.length === 0) showNoOrdersMessage();
          else {
            renderCurrentPage();
            updatePagination();
          }
          deleteModal.hide();
          alert("Order deleted successfully.");
        } else {
          const msg = result && result.message ? result.message : 'Failed to delete order';
          alert("Error deleting order: " + msg);
        }
      } catch (error) {
        console.error('Error deleting order:', error);
        alert('Error deleting order: ' + error.message);
      }
    });

    // ============================
    // Save Edit (POST + app_id header)
    // ============================
    document.getElementById("saveEditBtn").addEventListener("click", async () => {
      const newPodNo = document.getElementById("editPodNo").value.trim();
      const newConsigner = document.getElementById("editConsigner").value.trim();
      const newConsignee = document.getElementById("editConsignee").value.trim();
      const newStop = document.getElementById("editStop").value.trim();
      const newRoute = document.getElementById("editRoute").value.trim();
      const newDate = document.getElementById("editDate").value;
      const newPaymentStatus = document.getElementById("editPaymentStatus").value;

      if (!newPodNo || !newConsigner || !newConsignee || !newDate) {
        return alert("POD Number, Consigner, Consignee, and Date are required.");
      }

      try {
        const response = await fetch("https://www.loginlogistics.in/main/driverapp/update-order.php", {
          method: "POST",
          headers: {
            "Content-Type": "application/json"
          },
          body: JSON.stringify({
            app_id: "Mzk-",
            orderId: orderToEdit.id,
            updates: {
              podNo: newPodNo,
              consigner: newConsigner,
              consignee: newConsignee,
              stop: newStop,
              route: newRoute,
              date: newDate,
              paymentStatus: newPaymentStatus
            }
          })
        });

        const result = await response.json();

        if (result.success) {
          const index = allOrders.findIndex(order => order.id === orderToEdit.id);

          if (index !== -1) {
            allOrders[index] = {
              ...allOrders[index],
              podNo: newPodNo,
              consigner: newConsigner,
              consignee: newConsignee,
              stop: newStop,
              route: newRoute,
              date: newDate,
              paymentStatus: newPaymentStatus
            };
          }

          renderCurrentPage();
          editModal.hide();
          alert("Order updated successfully!");
        } else {
          alert("Error updating order: " + result.message);
        }

      } catch (error) {
        console.error("Error updating order:", error);
        alert("Update error: " + error.message);
      }
    });

    // Keyboard navigation
    document.addEventListener('keydown', function(e) {
      if (e.key === 'ArrowLeft' && currentPage > 1) {
        goToPreviousPage();
      } else if (e.key === 'ArrowRight' && currentPage < totalPages) {
        goToNextPage();
      }
    });

    // ============================
    // small helpers
    // ============================
    function escapeHtml(unsafe) {
      if (unsafe === null || unsafe === undefined) return '';
      return String(unsafe)
        .replace(/&/g, "&amp;")
        .replace(/</g, "&lt;")
        .replace(/>/g, "&gt;")
        .replace(/"/g, "&quot;")
        .replace(/'/g, "&#039;");
    }
  </script>
</body>
</html>