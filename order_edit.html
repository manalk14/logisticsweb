<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Edit Order - Consignor & Consignee</title>

  <!-- Bootstrap -->
  <link href="../bootstrap-5.3.8-dist/bootstrap-5.3.8-dist/css/bootstrap.min.css" rel="stylesheet" />
  <link rel="stylesheet" href="../fontawesome-free-7.1.0-web/fontawesome-free-7.1.0-web/css/all.min.css" />
  <link rel="stylesheet" href="css/order_edit.css">


</head>

<body>

  <!-- Header -->
  <header class="app-header">
    <i class="fa-solid fa-arrow-left me-2" id="backButton"></i> &nbsp;Edit Order
  </header>

  <main class="container my-4 pb-5 main-content">
    <!-- Loading Spinner -->
    <div id="loadingSpinner" class="loading-spinner">
      <div class="spinner-border text-primary" role="status">
        <span class="visually-hidden">Loading...</span>
      </div>
      <p class="mt-2">Loading order data...</p>
    </div>

    <!-- Order Not Found Message -->
    <div id="orderNotFound" class="order-not-found">
      <i class="fa-solid fa-box-open fa-3x mb-3"></i>
      <h4>Order Not Found</h4>
      <p>Could not find the specified order. Please check the order ID and try again.</p>
      <button class="btn btn-primary mt-2" onclick="window.location.href = 'view_order.html'">
        Back to Orders
      </button>
    </div>

    <!-- No Order Selected Message -->
    <div id="noOrderSelected" class="order-not-found" style="display: none;">
      <i class="fa-solid fa-exclamation-triangle fa-3x mb-3"></i>
      <h4>No Order Selected</h4>
      <p>Please select an order from the order list to edit.</p>
      <button class="btn btn-primary mt-2" onclick="window.location.href = 'view_order.html'">
        Back to Orders
      </button>
    </div>

    <form id="combinedForm" novalidate style="display: none;">

      <!-- CONSIGNOR DETAILS -->
      <div class="card mb-4">
        <div class="card-body">
          <div class="section-title"><i class="fa-solid fa-user"></i> Consignor Details</div>

          <div class="row mb-3">
            <div class="col-md-6 mb-3 autocomplete-wrapper">
              <label class="form-label">Company Name *</label>
              <input type="text" id="companyName" class="form-control required-field autocomplete-input" autocomplete="off">
              <div class="error-message">Please enter company name.</div>
            </div>
            <div class="col-md-6 mb-3">
              <label class="form-label">Supplier Invoice *</label>
              <input type="text" id="supplierInvoice" class="form-control required-field">
              <div class="error-message">Please enter supplier invoice.</div>
            </div>
          </div>

          <div class="row mb-3">
            <div class="col-md-6 mb-3 pod-no-field">
              <label class="form-label">POD No *</label>
              <input type="text" id="podNo" class="form-control required-field">
              <div class="error-message">Please enter POD No.</div>
            </div>
            <div class="col-md-6 mb-3 autocomplete-wrapper">
              <label class="form-label">City *</label>
              <input type="text" id="city" class="form-control required-field autocomplete-input" autocomplete="off">
              <div class="error-message">Please enter city.</div>
            </div>
          </div>

          <div class="mb-3">
            <label class="form-label">Address *</label>
            <textarea id="address" class="form-control required-field" rows="2"></textarea>
            <div class="error-message">Please enter address.</div>
          </div>

          <div class="row">
            <div class="col-md-6 mb-3">
              <label class="form-label">Phone Number *</label>
              <input type="tel" id="phone" class="form-control required-field" pattern="[0-9]{10}" placeholder="10-digit number">
              <div class="error-message">Enter a valid 10-digit number.</div>
            </div>
          </div>
        </div>
      </div>

      <!-- CONSIGNEE DETAILS -->
      <div class="card mb-4">
        <div class="card-body">
          <div class="section-title"><i class="fa-solid fa-user"></i> Consignee Details</div>

          <div class="row mb-3">
            <div class="col-md-6 mb-3 autocomplete-wrapper">
              <label class="form-label">Consignee Name *</label>
              <input type="text" id="cName" class="form-control required-field autocomplete-input" autocomplete="off">
              <div class="error-message">Please enter consignee name.</div>
            </div>
            <div class="col-md-6 mb-3 autocomplete-wrapper">
              <label class="form-label">City *</label>
              <input type="text" id="cCity" class="form-control required-field autocomplete-input" autocomplete="off">
              <div class="error-message">Please enter city.</div>
            </div>
          </div>

          <div class="row mb-3">
            <div class="col-md-6 mb-3">
              <label class="form-label">Route *</label>
              <input type="text" id="cRoute" class="form-control required-field" placeholder="Select city first to load routes">
              <div class="error-message">Please enter route.</div>
            </div>
            <div class="col-md-6 mb-3">
              <label class="form-label">Phone Number *</label>
              <input type="tel" id="cPhone" class="form-control required-field" pattern="[0-9]{10}" placeholder="10-digit number">
              <div class="error-message">Enter a valid 10-digit phone number.</div>
            </div>
          </div>

          <div class="mb-3">
            <label class="form-label">Address *</label>
            <textarea id="cAddress" class="form-control required-field" rows="2"></textarea>
            <div class="error-message">Please enter address.</div>
          </div>
        </div>
      </div>

      <!-- BOX AND COVER SIZE -->
      <div class="card mb-4">
        <div class="card-body">
          <div class="section-title"><i class="fa-solid fa-box"></i> Packaging Details</div>

          <div class="row">
            <!-- Box Section -->
            <div class="col-md-6">
              <div class="card h-100">
                <div class="section-title"><i class="fa-solid fa-cube"></i> Box</div>
                <div class="card-body">
                  <div class="row align-items-center mb-2">
                    <div class="col-4 fw-bold">Small</div>
                    <div class="col-4"><input type="number" class="form-control box-qty" data-size="small" placeholder="Qty" min="0"></div>
                    <div class="col-4"><input type="number" class="form-control box-price" data-size="small" placeholder="Price" min="0"></div>
                  </div>
                  <div class="row align-items-center mb-2">
                    <div class="col-4 fw-bold">Medium</div>
                    <div class="col-4"><input type="number" class="form-control box-qty" data-size="medium" placeholder="Qty" min="0"></div>
                    <div class="col-4"><input type="number" class="form-control box-price" data-size="medium" placeholder="Price" min="0"></div>
                  </div>
                  <div class="row align-items-center mb-2">
                    <div class="col-4 fw-bold">Large</div>
                    <div class="col-4"><input type="number" class="form-control box-qty" data-size="large" placeholder="Qty" min="0"></div>
                    <div class="col-4"><input type="number" class="form-control box-price" data-size="large" placeholder="Price" min="0"></div>
                  </div>
                  
                </div>
              </div>
            </div>

            <!-- Cover Section -->
            <div class="col-md-6">
              <div class="card h-100">
                <div class="section-title"><i class="fa-solid fa-envelope"></i> Cover</div>
                <div class="card-body">
                  <div class="row align-items-center mb-2">
                    <div class="col-4 fw-bold">Small</div>
                    <div class="col-4"><input type="number" class="form-control cover-qty" data-size="small" placeholder="Qty" min="0"></div>
                    <div class="col-4"><input type="number" class="form-control cover-price" data-size="small" placeholder="Price" min="0"></div>
                  </div>
                  <div class="row align-items-center mb-2">
                    <div class="col-4 fw-bold">Medium</div>
                    <div class="col-4"><input type="number" class="form-control cover-qty" data-size="medium" placeholder="Qty" min="0"></div>
                    <div class="col-4"><input type="number" class="form-control cover-price" data-size="medium" placeholder="Price" min="0"></div>
                  </div>
                  <div class="row align-items-center mb-2">
                    <div class="col-4 fw-bold">Large</div>
                    <div class="col-4"><input type="number" class="form-control cover-qty" data-size="large" placeholder="Qty" min="0"></div>
                    <div class="col-4"><input type="number" class="form-control cover-price" data-size="large" placeholder="Price" min="0"></div>
                  </div>
                </div>
              </div>
            </div>
          </div>
          <div class="error-message mt-3" id="boxCoverError">Please enter at least one Box AND one Cover with quantity and price.</div>
        </div>
      </div>

      <!-- PAYMENT TYPE -->
      <div class="card mb-4">
        <div class="card-body">
          <div class="section-title"><i class="fa-solid fa-credit-card"></i> Payment Type</div>
          <div class="row text-center">
            <div class="col-4">
              <div class="payment-box" id="noneBox" onclick="selectPayment('none')">
                <i class="fa-solid fa-ban fa-2x mb-2"></i>
                <div>None</div>
              </div>
            </div>
            <div class="col-4">
              <div class="payment-box" id="toPayBox" onclick="selectPayment('toPay')">
                <i class="fa-solid fa-money-bill-wave fa-2x mb-2"></i>
                <div>To Pay</div>
              </div>
            </div>
            <div class="col-4">
              <div class="payment-box" id="paidOrderBox" onclick="selectPayment('paidOrder')">
                <i class="fa-solid fa-circle-check fa-2x mb-2"></i>
                <div>Paid Order</div>
              </div>
            </div>
          </div>
          <div class="error-message mt-2" id="paymentError">Please select a payment type.</div>
        </div>
      </div>

    </form>
  </main>

  <!-- Fixed Footer Buttons -->
  <footer class="fixed-footer">
    <div class="container d-flex gap-2">
      <button type="button" class="btn btn-save w-100" id="saveButton">
        <i class="fas fa-save me-2"></i> Save Changes
      </button>
    </div>
  </footer>

  <!-- Bootstrap JS -->
  <script src="../bootstrap-5.3.8-dist/bootstrap-5.3.8-dist/js/bootstrap.bundle.min.js"></script>

  <script>
/* -------------------------
   Global State
-------------------------*/
let selectedPayment = null;
let currentOrderId = null;
let isConsignerFromDropdown = false;

// API Configuration
const BASE_URL = "https://www.loginlogistics.in/main/driverapp/";
const API_ENDPOINTS = {
  myOrders: "my-orders.php",
  editOrder: "edit-order.php",
  city: "get_city.php",
  consignee: "get_consignee.php",
  consigner: "get_consigner.php"
};

/* -------------------------
   Get Order ID (URL or Storage)
-------------------------*/
function getOrderId() {
  const urlParams = new URLSearchParams(window.location.search);
  const id = urlParams.get("ord_id") || urlParams.get("orderId") || localStorage.getItem("selected_order_id");
  console.log("Order ID detected:", id);
  return id;
}

/* -------------------------
   Page Show/Hide Helpers
-------------------------*/
function showLoading(isVisible) {
  document.getElementById("loadingSpinner").style.display = isVisible ? "block" : "none";
  document.getElementById("combinedForm").style.display = isVisible ? "none" : "block";
  document.getElementById("orderNotFound").style.display = "none";
  document.getElementById("noOrderSelected").style.display = "none";
}

function showNotFound() {
  document.getElementById("combinedForm").style.display = "none";
  document.getElementById("orderNotFound").style.display = "block";
  document.getElementById("loadingSpinner").style.display = "none";
  document.getElementById("noOrderSelected").style.display = "none";
}

function showNoSelection() {
  document.getElementById("combinedForm").style.display = "none";
  document.getElementById("noOrderSelected").style.display = "block";
  document.getElementById("loadingSpinner").style.display = "none";
  document.getElementById("orderNotFound").style.display = "none";
}

/* -------------------------
   Fetch Order Data
-------------------------*/
async function fetchOrder(orderId) {
  showLoading(true);

  const body = {
    app_id: localStorage.getItem("app_id"),
    ord_id: orderId
  };

  try {
    const response = await fetch(BASE_URL + API_ENDPOINTS.editOrder, {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify(body)
    });

    const data = await response.json();
    console.log("Response data:", data);

    // ðŸš¨ FIX: API returns SINGLE object, not an array
    if (!data || !data.ord_id) {
      showNotFound();
      return;
    }

    // Pass response object directly
    populateForm(data);

    showLoading(false);
  } catch (err) {
    console.error(err);
    showNotFound();
  }
}


/* -------------------------
   Populate Form - UPDATED FOR YOUR API STRUCTURE
-------------------------*/
function populateForm(order) {
  console.log("Populating form with:", order);

  // Map API fields to form fields based on your API response
  document.getElementById("companyName").value = order.consignor_name || "";
  document.getElementById("supplierInvoice").value = order.supp_inv_no || "";
  document.getElementById("podNo").value = order.pod_no || "";
  document.getElementById("city").value = order.consignor_city || "";
  document.getElementById("address").value = order.consignor_address || "";
  document.getElementById("phone").value = order.consignor_phone || "";

  document.getElementById("cName").value = order.consignee_name || "";
  document.getElementById("cCity").value = order.consignee_city || "";
  document.getElementById("cRoute").value = order.route || order.route_name || "";
  document.getElementById("cPhone").value = order.consignee_phone || "";
  document.getElementById("cAddress").value = order.consignee_address || "";

  // Set consigner flag if consignor has ID
  if (order.consignorId) {
    document.getElementById("companyName").dataset.selectedId = order.consignorId;
    document.getElementById("companyName").dataset.originalValue = order.consignor_name;
    isConsignerFromDropdown = true;
    updatePodNoField();
    updatePaymentOptions();
  }

  // Set city IDs if available
  if (order.consignor_cityId) {
    document.getElementById("city").dataset.selectedId = order.consignor_cityId;
  }
  if (order.consignee_cityId) {
    document.getElementById("cCity").dataset.selectedId = order.consignee_cityId;
  }
  if (order.consigneeId) {
    document.getElementById("cName").dataset.selectedId = order.consigneeId;
  }

  // Populate Box and Cover data from individual fields
  populatePackagingData(order);

  // Payment Restore
  if (order.payment_type) selectPayment(order.payment_type);

  // Initialize autocomplete after populating data
  initAutocomplete();
}

/* -------------------------
   Populate Packaging Data from Individual Fields
-------------------------*/
function populatePackagingData(order) {
  // Box data
  const boxSizes = ['small', 'medium', 'large', 'xlarge'];
  
  boxSizes.forEach(size => {
    const qtyField = `box_${size}_qty`;
    const priceField = `box_${size}_price`;
    
    const qtyInput = document.querySelector(`.box-qty[data-size='${size}']`);
    const priceInput = document.querySelector(`.box-price[data-size='${size}']`);
    
    if (qtyInput && order[qtyField] !== undefined) {
      qtyInput.value = order[qtyField] || "0";
    }
    if (priceInput && order[priceField] !== undefined) {
      priceInput.value = order[priceField] || "0";
    }
  });

  // Cover data
  const coverSizes = ['small', 'medium', 'large', 'xlarge'];
  
  coverSizes.forEach(size => {
    const qtyField = `cover_${size}_qty`;
    const priceField = `cover_${size}_price`;
    
    const qtyInput = document.querySelector(`.cover-qty[data-size='${size}']`);
    const priceInput = document.querySelector(`.cover-price[data-size='${size}']`);
    
    if (qtyInput && order[qtyField] !== undefined) {
      qtyInput.value = order[qtyField] || "0";
    }
    if (priceInput && order[priceField] !== undefined) {
      priceInput.value = order[priceField] || "0";
    }
  });
}

/* -------------------------
   Autocomplete Functionality
-------------------------*/
function createAutocomplete(inputId, endpoint, listKey, displayKey, valueKey, onSelectCallback = null) {
  const input = document.getElementById(inputId);
  if (!input) return;
  
  const wrapper = input.parentElement;
  let currentList;
  let currentFocus = -1;

  function removeCurrentList() {
    if (currentList) {
      currentList.remove();
      currentList = null;
      currentFocus = -1;
    }
  }

  function setActive(items, direction) {
    if (!items) return;
    
    removeActive(items);
    
    if (direction === 'down') {
      currentFocus++;
      if (currentFocus >= items.length) currentFocus = 0;
    } else if (direction === 'up') {
      currentFocus--;
      if (currentFocus < 0) currentFocus = items.length - 1;
    }
    
    if (currentFocus >= 0 && currentFocus < items.length) {
      items[currentFocus].classList.add('active');
      items[currentFocus].scrollIntoView({ block: 'nearest' });
    }
  }

  function removeActive(items) {
    items.forEach(item => item.classList.remove('active'));
  }

  function selectActiveItem(items) {
    if (currentFocus > -1 && items && items[currentFocus]) {
      items[currentFocus].click();
    }
  }

  input.addEventListener("input", function () {
    const val = this.value.trim().toLowerCase();
    removeCurrentList();
    
    // Reset consigner flag when user types manually or clears the field
    if (inputId === "companyName") {
      if (!this.dataset.selectedId || this.value !== this.dataset.originalValue) {
        isConsignerFromDropdown = false;
        updatePodNoField();
        updatePaymentOptions();
      }
    }
    
    if (!val) {
      if (inputId === "companyName") {
        isConsignerFromDropdown = false;
        updatePodNoField();
        updatePaymentOptions();
      }
      return;
    }

    const body = {
      app_id: localStorage.getItem("app_id") || "Mzk-",
      search: val,
      term: val
    };

    fetch(BASE_URL + endpoint, {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify(body)
    })
    .then(r => r.json())
    .then(data => {
      let arr = data[listKey] || [];
      currentList = document.createElement("div");
      currentList.className = "autocomplete-items";
      wrapper.appendChild(currentList);

      if (arr.length === 0) {
        const noResults = document.createElement("div");
        noResults.className = "no-results";
        noResults.textContent = "No results found";
        currentList.appendChild(noResults);
        return;
      }

      arr.forEach(item => {
        const text = item[displayKey] || "";
        const id = item[valueKey] || "";

        if (text.toLowerCase().includes(val)) {
          const div = document.createElement("div");
          div.className = "autocomplete-item";
          div.textContent = text;

          div.onclick = () => {
            input.value = text;
            input.dataset.selectedId = id;
            input.dataset.originalValue = text;

            // Set consigner flag when selected from dropdown
            if (inputId === "companyName") {
              isConsignerFromDropdown = true;
              updatePodNoField();
              updatePaymentOptions();
            }

            if (onSelectCallback && typeof onSelectCallback === 'function') {
              onSelectCallback(item);
            }

            removeCurrentList();
          };

          currentList.appendChild(div);
        }
      });
    })
    .catch(err => {
      console.error('Error fetching data:', err);
    });
  });

  // Keyboard navigation
  input.addEventListener("keydown", function(e) {
    const items = currentList ? currentList.querySelectorAll('.autocomplete-item') : null;
    
    if (e.key === 'ArrowDown') {
      e.preventDefault();
      if (items && items.length > 0) {
        setActive(items, 'down');
      }
    } else if (e.key === 'ArrowUp') {
      e.preventDefault();
      if (items && items.length > 0) {
        setActive(items, 'up');
      }
    } else if (e.key === 'Enter') {
      e.preventDefault();
      if (items && items.length > 0) {
        selectActiveItem(items);
      }
    } else if (e.key === 'Escape') {
      removeCurrentList();
    }
  });

  // Close dropdown when input loses focus
  input.addEventListener("blur", function() {
    setTimeout(removeCurrentList, 150);
  });

  // Add event listener for manual clearing
  input.addEventListener('change', function() {
    if (inputId === "companyName") {
      if (this.dataset.selectedId && this.value !== this.dataset.originalValue) {
        isConsignerFromDropdown = false;
        delete this.dataset.selectedId;
        delete this.dataset.originalValue;
        updatePodNoField();
        updatePaymentOptions();
      }
    }
  });
}

// Function to auto-fill city and address when consigner is selected
function onConsignerSelect(selectedItem) {
  const cityInput = document.getElementById('city');
  const addressInput = document.getElementById('address');
  
  if (selectedItem.startsfrom && cityInput) {
    cityInput.value = selectedItem.startsfrom;
    cityInput.dataset.selectedId = selectedItem.stcompanyid || '';
  }
  
  if (selectedItem.address && addressInput) {
    addressInput.value = selectedItem.address;
  }
}

// Function to auto-fill city and route when consignee is selected
function onConsigneeSelect(selectedItem) {
  const cityInput = document.getElementById('cCity');
  const addressInput = document.getElementById('cAddress');
  const phoneInput = document.getElementById('cPhone');
  
  if (selectedItem.destination && cityInput) {
    cityInput.value = selectedItem.destination;
    cityInput.dataset.destinationid = selectedItem.destinationid || '';
  }
  
  if (selectedItem.dst_address && addressInput) {
    addressInput.value = selectedItem.dst_address;
  }
  
  if (selectedItem.dst_phone_number && phoneInput) {
    phoneInput.value = selectedItem.dst_phone_number;
  }
}

function initAutocomplete() {
  createAutocomplete(
    "companyName",
    API_ENDPOINTS.consigner,
    "consignordet",
    "company_name",
    "stcompanyid",
    onConsignerSelect
  );

  createAutocomplete(
    "city",
    API_ENDPOINTS.city,
    "citydet",
    "city_name",
    "cityid"
  );

  createAutocomplete(
    "cName",
    API_ENDPOINTS.consignee,
    "consigneedet",
    "dst_company_name",
    "dstcompanyid",
    onConsigneeSelect
  );

  createAutocomplete(
    "cCity",
    API_ENDPOINTS.city,
    "citydet",
    "city_name",
    "cityid"
  );
}

// Function to update POD No field validation
function updatePodNoField() {
  const podNoField = document.querySelector('.pod-no-field');
  const podNoInput = document.getElementById('podNo');
  
  if (!podNoField || !podNoInput) return;
  
  if (isConsignerFromDropdown) {
    podNoField.classList.add('optional');
    podNoInput.classList.remove('required-field');
    podNoInput.placeholder = "Optional when consigner selected from list";
  } else {
    podNoField.classList.remove('optional');
    podNoInput.classList.add('required-field');
    podNoInput.placeholder = "Enter POD No";
  }
}

// Function to update payment options based on consigner selection
function updatePaymentOptions() {
  const nonePaymentBox = document.getElementById('noneBox');
  
  if (!nonePaymentBox) return;
  
  if (isConsignerFromDropdown) {
    nonePaymentBox.classList.remove('payment-disabled');
    nonePaymentBox.style.cursor = 'pointer';
    nonePaymentBox.title = '';
  } else {
    nonePaymentBox.classList.add('payment-disabled');
    nonePaymentBox.style.cursor = 'not-allowed';
    nonePaymentBox.title = 'None payment only available when consigner is selected from dropdown';
    
    if (selectedPayment === 'none') {
      selectedPayment = null;
      nonePaymentBox.classList.remove('active');
    }
  }
}

/* -------------------------
   Payment Selection
-------------------------*/
function selectPayment(type) {
  if (type === 'none' && !isConsignerFromDropdown) {
    alert("None payment type is only available when consigner is selected from dropdown");
    return;
  }
  
  document.querySelectorAll(".payment-box").forEach(x => x.classList.remove("active"));
  document.getElementById(type + "Box").classList.add("active");
  selectedPayment = type;
  document.getElementById("paymentError").style.display = "none";
}

/* -------------------------
   Save Changes - UPDATED FOR YOUR API STRUCTURE
-------------------------*/
document.getElementById("saveButton").addEventListener("click", async () => {
  if (!currentOrderId) {
    alert("Order ID missing!");
    return;
  }

  // Validate required fields
  const requiredFields = document.querySelectorAll('.required-field');
  let isValid = true;
  
  requiredFields.forEach(field => {
    // Skip validation for POD No when consigner is from dropdown
    if (field.id === 'podNo' && isConsignerFromDropdown) {
      return;
    }
    
    const value = (field.value || '').trim();
    
    if (field.type === 'tel' && field.pattern) {
      const reg = new RegExp(`^${field.pattern}$`);
      if (!reg.test(value)) {
        field.classList.add('is-invalid-field');
        field.nextElementSibling.style.display = 'block';
        isValid = false;
        return;
      }
    }
    
    if (!value) {
      field.classList.add('is-invalid-field');
      field.nextElementSibling.style.display = 'block';
      isValid = false;
      return;
    }
    
    field.classList.remove('is-invalid-field');
    field.nextElementSibling.style.display = 'none';
  });

  if (!isValid) {
    alert('âš ï¸ Please correct highlighted fields.');
    return;
  }

  if (!selectedPayment) {
    document.getElementById('paymentError').style.display = 'block';
    alert('âš ï¸ Please select a payment type.');
    return;
  }

  // Collect packaging data
  const boxData = {
    small: { qty: 0, price: 0 },
    medium: { qty: 0, price: 0 },
    large: { qty: 0, price: 0 },
    xlarge: { qty: 0, price: 0 }
  };

  const coverData = {
    small: { qty: 0, price: 0 },
    medium: { qty: 0, price: 0 },
    large: { qty: 0, price: 0 },
    xlarge: { qty: 0, price: 0 }
  };

  document.querySelectorAll('.box-qty').forEach(input => {
    const size = input.dataset.size;
    const value = parseInt(input.value) || 0;
    if (value > 0) boxData[size].qty = value;
  });

  document.querySelectorAll('.box-price').forEach(input => {
    const size = input.dataset.size;
    const value = parseFloat(input.value) || 0;
    if (value > 0) boxData[size].price = value;
  });

  document.querySelectorAll('.cover-qty').forEach(input => {
    const size = input.dataset.size;
    const value = parseInt(input.value) || 0;
    if (value > 0) coverData[size].qty = value;
  });

  document.querySelectorAll('.cover-price').forEach(input => {
    const size = input.dataset.size;
    const value = parseFloat(input.value) || 0;
    if (value > 0) coverData[size].price = value;
  });

  // Updated body structure to match your API
  const body = {
    app_id: localStorage.getItem("app_id") || "Mzk-",
    ord_id: currentOrderId,
    consignor_name: document.getElementById("companyName").value,
    consignorId: document.getElementById("companyName").dataset.selectedId || '',
    supp_inv_no: document.getElementById("supplierInvoice").value,
    pod_no: document.getElementById("podNo").value,
    consignor_city: document.getElementById("city").value,
    consignor_cityId: document.getElementById("city").dataset.selectedId || '',
    consignor_address: document.getElementById("address").value,
    consignor_phone: document.getElementById("phone").value,
    consignee_name: document.getElementById("cName").value,
    consigneeId: document.getElementById("cName").dataset.selectedId || '',
    consignee_city: document.getElementById("cCity").value,
    consignee_cityId: document.getElementById("cCity").dataset.selectedId || '',
    route: document.getElementById("cRoute").value,
    consignee_phone: document.getElementById("cPhone").value,
    consignee_address: document.getElementById("cAddress").value,
    payment_type: selectedPayment,
    box_data: JSON.stringify(boxData),
    cover_data: JSON.stringify(coverData)
  };

 // Add this line right before the fetch call
printUpdatedDataToConsole(body);

// Your existing fetch call
try {
  const response = await fetch(BASE_URL + API_ENDPOINTS.editOrder, {
    method: "POST",
    headers: { "Content-Type": "application/json" },
    body: JSON.stringify(body)
  });
  // ... rest of your code

    const result = await response.json();
    console.log("Save response:", result);

    alert(result.message || "Order Updated Successfully!");
  } catch (err) {
    console.error("Error updating order:", err);
    alert("Server error, please try again later.");
  }
});
/* -------------------------
   Console Print Updated Data in JSON Format
-------------------------*/
function printUpdatedDataToConsole(body) {
  console.log("=== UPDATED ORDER DATA (JSON) ===");
  console.log(JSON.stringify(body, null, 2));
  console.log("=== END UPDATED DATA ===");
}
/* -------------------------
   Back Button
-------------------------*/
document.getElementById("backButton").addEventListener("click", () => {
  window.location.href = "view_order.html";
});

/* -------------------------
   On Load
-------------------------*/
document.addEventListener("DOMContentLoaded", () => {
  currentOrderId = getOrderId();
  if (!currentOrderId) return showNoSelection();
  fetchOrder(currentOrderId);
});
</script>
</body>
</html>