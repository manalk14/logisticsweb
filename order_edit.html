<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Edit Order - Consignor & Consignee</title>

  <!-- Bootstrap -->
  <link href="../bootstrap-5.3.8-dist/bootstrap-5.3.8-dist/css/bootstrap.min.css" rel="stylesheet" />
  <link rel="stylesheet" href="../fontawesome-free-7.1.0-web/fontawesome-free-7.1.0-web/css/all.min.css" />
  
  <style>
    /* Your existing CSS styles remain the same */
    .app-header {
      background: #ffca1d;
      color: rgb(0, 0, 0);
      padding: 15px 20px;
      font-size: 1.25rem;
      font-weight: 600;
      position: sticky;
      top: 0;
      z-index: 100;
      display: flex;
      align-items: center;
    }
    
    .app-header i {
      cursor: pointer;
      transition: transform 0.2s;
      font-size: 1.2rem;
    }
  
    
    .header-title {
      flex-grow: 1;
      text-align: left;
      margin-right: 40px;
      font-style: bold;
    }
    
    .main-content {
      max-width: 1000px;
      margin: 0 auto;
    }
    
    .card {
      border: none;
      border-radius: 12px;
      margin-bottom: 20px;
    }
    
    .section-title {
      font-weight: 600;
      color: #2c3e50;
      margin-bottom: 20px;
      padding-bottom: 10px;
      border-bottom: 1px solid #eaeaea;
      display: flex;
      align-items: center;
      gap: 10px;
    }
    
    .section-title i {
      color: #000000;
    }
    
    .form-label {
      font-weight: 500;
      color: #000000;
      margin-bottom: 8px;
    }
    
    .form-control {
      border-radius: 8px;
      padding: 10px 15px;
      border: 1px solid #ddd;
      transition: all 0.3s;
    }
    
    .form-control:focus {
      border-color: #ffca1d;
    }
    
    .error-message {
      color: #e74c3c;
      font-size: 0.875rem;
      margin-top: 5px;
      display: none;
    }
    
    .is-invalid-field {
      border-color: #e74c3c !important;
    }
    
    .is-invalid-field + .error-message {
      display: block;
    }
    
    .payment-box {
      border: 2px solid #e0e0e0;
      border-radius: 10px;
      padding: 15px 10px;
      text-align: center;
      cursor: pointer;
      transition: all 0.3s;
      background-color: white;
    }
    
    .payment-box:hover {
      border-color: #ffca1d;
      transform: translateY(-3px);
    }
    
    .payment-box.active {
      border-color: #000000;
    }
    
    .payment-disabled {
      opacity: 0.5;
      cursor: not-allowed !important;
    }
    
    .payment-disabled:hover {
      border-color: #e0e0e0;
      transform: none;
    }
    
    .fixed-footer {
      position: fixed;
      bottom: 0;
      left: 0;
      right: 0;
      background-color: white;
      padding: 15px;
      z-index: 100;
    }
    
    .btn-save {
      background: #ffca1d;
      color: rgb(0, 0, 0);
      border: none;
      border-radius: 8px;
      padding: 12px 20px;
      font-weight: 600;
      transition: all 0.3s;
    }
    
    .btn-save:hover {
      transform: translateY(-2px);
    }
    
    .loading-spinner {
      text-align: center;
      padding: 40px 20px;
      color: #000000;
    }
    
    .order-not-found {
      text-align: center;
      padding: 40px 20px;
      color: #ffa034;
    }
    
    .order-not-found i {
      color: #f39c12;
      margin-bottom: 20px;
    }
    
    .autocomplete-wrapper {
      position: relative;
    }
    
    .autocomplete-items {
      position: absolute;
      border: 1px solid #ddd;
      border-top: none;
      z-index: 99;
      top: 100%;
      left: 0;
      right: 0;
      background-color: white;
      border-radius: 0 0 8px 8px;
      max-height: 200px;
      overflow-y: auto;
    
    }
    
    .autocomplete-item {
      padding: 10px 15px;
      cursor: pointer;
      border-bottom: 1px solid #f1f1f1;
    }
    
    .autocomplete-item:hover, .autocomplete-item.active {
      background-color: rgba(255, 202, 29, 0.1);
    }
    
    .no-results {
      padding: 10px 15px;
      color: #777;
      font-style: italic;
    }
    
    .optional .form-label::after {
      content: " (Optional)";
      font-weight: normal;
      color: #6c757d;
    }
    
    @media (max-width: 768px) {
      .app-header {
        padding: 12px 15px;
        font-size: 1.1rem;
      }
      
      .card-body {
        padding: 15px;
      }
      
      .section-title {
        font-size: 1.1rem;
      }
      
      .payment-box {
        padding: 10px 5px;
        font-size: 0.9rem;
      }
      
      .payment-box i {
        font-size: 1.5rem;
      }
    }
  </style>
</head>

<body>

  <!-- Updated Header -->
  <header class="app-header">
    <i class="fa-solid fa-arrow-left me-2" id="backButton"></i>
    <div class="header-title">Edit Order</div>
  </header>

  <main class="container my-4 pb-5 main-content">
    <!-- Loading Spinner -->
    <div id="loadingSpinner" class="loading-spinner">
      <div class="spinner-border text-primary" role="status">
        <span class="visually-hidden">Loading...</span>
      </div>
      <p class="mt-2">Loading order data...</p>
    </div>

    <!-- Order Not Found Message -->
    <div id="orderNotFound" class="order-not-found">
      <i class="fa-solid fa-box-open fa-3x mb-3"></i>
      <h4>Order Not Found</h4>
      <p>Could not find the specified order. Please check the order ID and try again.</p>
      <button class="btn btn-primary mt-2" onclick="window.location.href = 'view_order.html'">
        Back to Orders
      </button>
    </div>

    <!-- No Order Selected Message -->
    <div id="noOrderSelected" class="order-not-found" style="display: none;">
      <i class="fa-solid fa-exclamation-triangle fa-3x mb-3"></i>
      <h4>No Order Selected</h4>
      <p>Please select an order from the order list to edit.</p>
      <button class="btn btn-primary mt-2" onclick="window.location.href = 'view_order.html'">
        Back to Orders
      </button>
    </div>

    <form id="combinedForm" novalidate style="display: none;">

      <!-- CONSIGNOR DETAILS -->
      <div class="card mb-4">
        <div class="card-body">
          <div class="section-title"><i class="fa-solid fa-user"></i> Consignor Details</div>

          <div class="row mb-3">
            <div class="col-md-6 mb-3 autocomplete-wrapper">
              <label class="form-label">Company Name *</label>
              <input type="text" id="companyName" class="form-control required-field autocomplete-input" autocomplete="off">
              <div class="error-message">Please enter company name.</div>
            </div>
            <div class="col-md-6 mb-3">
              <label class="form-label">Supplier Invoice *</label>
              <input type="text" id="supplierInvoice" class="form-control required-field">
              <div class="error-message">Please enter supplier invoice.</div>
            </div>
          </div>

          <div class="row mb-3">
            <div class="col-md-6 mb-3 pod-no-field">
              <label class="form-label">POD No *</label>
              <input type="text" id="podNo" class="form-control required-field">
              <div class="error-message">Please enter POD No.</div>
            </div>
            <div class="col-md-6 mb-3 autocomplete-wrapper">
              <label class="form-label">City *</label>
              <input type="text" id="city" class="form-control required-field autocomplete-input" autocomplete="off">
              <div class="error-message">Please enter city.</div>
            </div>
          </div>

          <div class="mb-3">
            <label class="form-label">Address *</label>
            <textarea id="address" class="form-control required-field" rows="2"></textarea>
            <div class="error-message">Please enter address.</div>
          </div>

          <div class="row">
            <div class="col-md-6 mb-3">
              <label class="form-label">Phone Number *</label>
              <input type="tel" id="phone" class="form-control required-field" pattern="[0-9]{10}" placeholder="10-digit number">
              <div class="error-message">Enter a valid 10-digit number.</div>
            </div>
          </div>
        </div>
      </div>

      <!-- CONSIGNEE DETAILS -->
      <div class="card mb-4">
        <div class="card-body">
          <div class="section-title"><i class="fa-solid fa-user"></i> Consignee Details</div>

          <div class="row mb-3">
            <div class="col-md-6 mb-3 autocomplete-wrapper">
              <label class="form-label">Consignee Name *</label>
              <input type="text" id="cName" class="form-control required-field autocomplete-input" autocomplete="off">
              <div class="error-message">Please enter consignee name.</div>
            </div>
            <div class="col-md-6 mb-3 autocomplete-wrapper">
              <label class="form-label">City *</label>
              <input type="text" id="cCity" class="form-control required-field autocomplete-input" autocomplete="off">
              <div class="error-message">Please enter city.</div>
            </div>
          </div>

          <div class="row mb-3">
            <div class="col-md-6 mb-3">
              <label class="form-label">Route *</label>
              <input type="text" id="cRoute" class="form-control required-field" placeholder="Select city first to load routes">
              <div class="error-message">Please enter route.</div>
            </div>
            <div class="col-md-6 mb-3">
              <label class="form-label">Phone Number *</label>
              <input type="tel" id="cPhone" class="form-control required-field" pattern="[0-9]{10}" placeholder="10-digit number">
              <div class="error-message">Enter a valid 10-digit phone number.</div>
            </div>
          </div>

          <div class="mb-3">
            <label class="form-label">Address *</label>
            <textarea id="cAddress" class="form-control required-field" rows="2"></textarea>
            <div class="error-message">Please enter address.</div>
          </div>
        </div>
      </div>

      <!-- BOX AND COVER SIZE -->
      <div class="card mb-4">
        <div class="card-body">
          <div class="section-title"><i class="fa-solid fa-box"></i> Packaging Details</div>

          <div class="row">
            <!-- Box Section -->
            <div class="col-md-6">
              <div class="card h-100">
                <div class="section-title"><i class="fa-solid fa-cube"></i> Box</div>
                <div class="card-body">
                  <div class="row align-items-center mb-2">
                    <div class="col-4 fw-bold">Small</div>
                    <div class="col-4"><input type="number" class="form-control box-qty" data-size="small" placeholder="Qty" min="0"></div>
                    <div class="col-4"><input type="number" class="form-control box-price" data-size="small" placeholder="Price" min="0"></div>
                  </div>
                  <div class="row align-items-center mb-2">
                    <div class="col-4 fw-bold">Medium</div>
                    <div class="col-4"><input type="number" class="form-control box-qty" data-size="medium" placeholder="Qty" min="0"></div>
                    <div class="col-4"><input type="number" class="form-control box-price" data-size="medium" placeholder="Price" min="0"></div>
                  </div>
                  <div class="row align-items-center mb-2">
                    <div class="col-4 fw-bold">Large</div>
                    <div class="col-4"><input type="number" class="form-control box-qty" data-size="large" placeholder="Qty" min="0"></div>
                    <div class="col-4"><input type="number" class="form-control box-price" data-size="large" placeholder="Price" min="0"></div>
                  </div>
             
                </div>
              </div>
            </div>

            <!-- Cover Section -->
            <div class="col-md-6">
              <div class="card h-100">
                <div class="section-title"><i class="fa-solid fa-envelope"></i> Cover</div>
                <div class="card-body">
                  <div class="row align-items-center mb-2">
                    <div class="col-4 fw-bold">Small</div>
                    <div class="col-4"><input type="number" class="form-control cover-qty" data-size="small" placeholder="Qty" min="0"></div>
                    <div class="col-4"><input type="number" class="form-control cover-price" data-size="small" placeholder="Price" min="0"></div>
                  </div>
                  <div class="row align-items-center mb-2">
                    <div class="col-4 fw-bold">Medium</div>
                    <div class="col-4"><input type="number" class="form-control cover-qty" data-size="medium" placeholder="Qty" min="0"></div>
                    <div class="col-4"><input type="number" class="form-control cover-price" data-size="medium" placeholder="Price" min="0"></div>
                  </div>
                  <div class="row align-items-center mb-2">
                    <div class="col-4 fw-bold">Large</div>
                    <div class="col-4"><input type="number" class="form-control cover-qty" data-size="large" placeholder="Qty" min="0"></div>
                    <div class="col-4"><input type="number" class="form-control cover-price" data-size="large" placeholder="Price" min="0"></div>
                  </div>
                </div>
              </div>
            </div>
          </div>
          <div class="error-message mt-3" id="boxCoverError">Please enter at least one Box AND one Cover with quantity and price.</div>
        </div>
      </div>

      <!-- PAYMENT TYPE -->
      <div class="card mb-4">
        <div class="card-body">
          <div class="section-title"><i class="fa-solid fa-credit-card"></i> Payment Type</div>
          <div class="row text-center">
            <div class="col-4">
              <div class="payment-box" id="noneBox" onclick="selectPayment('none')">
                <i class="fa-solid fa-ban fa-2x mb-2"></i>
                <div>None</div>
              </div>
            </div>
            <div class="col-4">
              <div class="payment-box" id="toPayBox" onclick="selectPayment('toPay')">
                <i class="fa-solid fa-money-bill-wave fa-2x mb-2"></i>
                <div>To Pay</div>
              </div>
            </div>
            <div class="col-4">
              <div class="payment-box" id="paidOrderBox" onclick="selectPayment('paidOrder')">
                <i class="fa-solid fa-circle-check fa-2x mb-2"></i>
                <div>Paid Order</div>
              </div>
            </div>
          </div>
          <div class="error-message mt-2" id="paymentError">Please select a payment type.</div>
        </div>
      </div>

    </form>
  </main>

  <!-- Fixed Footer Buttons -->
  <footer class="fixed-footer">
    <div class="container d-flex gap-2">
      <button type="button" class="btn btn-save w-100" id="saveButton">
        <i class="fas fa-save me-2"></i> Save Changes
      </button>
    </div>
  </footer>

  <!-- Bootstrap JS -->
  <script src="../bootstrap-5.3.8-dist/bootstrap-5.3.8-dist/js/bootstrap.bundle.min.js"></script>

  <script>
/* -------------------------
   Global State
-------------------------*/
let selectedPayment = null;
let currentOrderId = null;
let isConsignerFromDropdown = false;

// Check for app_id on page load
document.addEventListener('DOMContentLoaded', function() {
  const app_id = localStorage.getItem("app_id");
  
  if (!app_id) {
    alert("Error: app_id not found in localStorage. Please login again.");
    window.location.href = 'login.html';
    return;
  }
});

// API Configuration
const BASE_URL = "https://www.loginlogistics.in/main/driverapp/";
const UPDATE_ORDER_API = "https://www.loginlogistics.in/main/driverapp/action/update-order.php";

// Simple fetch function without CORS proxies that often fail
async function safeFetch(url, options = {}) {
  try {
    // Try direct fetch first
    const response = await fetch(url, {
      ...options,
      headers: {
        'Content-Type': 'application/json',
        ...options.headers
      }
    });
    
    if (!response.ok) {
      throw new Error(`HTTP error! status: ${response.status}`);
    }
    
    return response;
  } catch (error) {
    console.error('Fetch error:', error);
    
    // If direct fetch fails due to CORS, try with no-cors mode for simple requests
    if (error.message.includes('CORS') || error.message.includes('Failed to fetch')) {
      console.log('CORS error detected, trying alternative approach...');
      
      // For simple data submission, you might need to use form submission
      // or contact the API provider to enable CORS
      throw new Error('CORS policy blocks the request. Please contact the API provider to enable CORS headers.');
    }
    
    throw error;
  }
}

/* -------------------------
   Get Order ID (URL or Storage)
-------------------------*/
function getOrderId() {
  const urlParams = new URLSearchParams(window.location.search);
  const id = urlParams.get("ord_id") || urlParams.get("orderId") || localStorage.getItem("selected_order_id");
  console.log("Order ID detected:", id);
  return id;
}

/* -------------------------
   Page Show/Hide Helpers
-------------------------*/
function showLoading(isVisible) {
  document.getElementById("loadingSpinner").style.display = isVisible ? "block" : "none";
  document.getElementById("combinedForm").style.display = isVisible ? "none" : "block";
  document.getElementById("orderNotFound").style.display = "none";
  document.getElementById("noOrderSelected").style.display = "none";
}

function showNotFound() {
  document.getElementById("combinedForm").style.display = "none";
  document.getElementById("orderNotFound").style.display = "block";
  document.getElementById("loadingSpinner").style.display = "none";
  document.getElementById("noOrderSelected").style.display = "none";
}

function showNoSelection() {
  document.getElementById("combinedForm").style.display = "none";
  document.getElementById("noOrderSelected").style.display = "block";
  document.getElementById("loadingSpinner").style.display = "none";
  document.getElementById("orderNotFound").style.display = "none";
}

/* -------------------------
   Fetch Order Data
-------------------------*/
async function fetchOrder(orderId) {
  showLoading(true);

  const body = {
    app_id: localStorage.getItem("app_id"),
    ord_id: orderId
  };

  try {
    const response = await safeFetch(BASE_URL + "edit-order.php", {
      method: "POST",
      body: JSON.stringify(body)
    });

    const data = await response.json();
    console.log("Response data:", data);

    if (!data || !data.ord_id) {
      showNotFound();
      return;
    }

    populateForm(data);
    showLoading(false);
  } catch (err) {
    console.error("Error fetching order:", err);
    showNotFound();
  }
}

/* -------------------------
   Populate Form
-------------------------*/
function populateForm(order) {
  console.log("Populating form with:", order);

  // Map API fields to form fields
  document.getElementById("companyName").value = order.consignor_name || "";
  document.getElementById("supplierInvoice").value = order.supp_inv_no || "";
  document.getElementById("podNo").value = order.pod_no || "";
  document.getElementById("city").value = order.consignor_city || "";
  document.getElementById("address").value = order.consignor_address || "";
  document.getElementById("phone").value = order.consignor_phone || "";

  document.getElementById("cName").value = order.consignee_name || "";
  document.getElementById("cCity").value = order.consignee_city || "";
  document.getElementById("cRoute").value = order.route || order.route_name || "";
  document.getElementById("cPhone").value = order.consignee_phone || "";
  document.getElementById("cAddress").value = order.consignee_address || "";

  // Set consigner flag if consignor has ID
  if (order.consignorId) {
    document.getElementById("companyName").dataset.selectedId = order.consignorId;
    document.getElementById("companyName").dataset.originalValue = order.consignor_name;
    isConsignerFromDropdown = true;
    updatePodNoField();
    updatePaymentOptions();
  }

  // Populate Box and Cover data
  populatePackagingData(order);

  // Payment Restore
  if (order.payment_type) selectPayment(order.payment_type);

  // Initialize autocomplete after populating data
  initAutocomplete();
}

/* -------------------------
   Populate Packaging Data
-------------------------*/
function populatePackagingData(order) {
  // Box data
  const boxSizes = ['small', 'medium', 'large'];
  
  boxSizes.forEach(size => {
    const qtyField = `box_${size}_qty`;
    const priceField = `box_${size}_price`;
    
    const qtyInput = document.querySelector(`.box-qty[data-size='${size}']`);
    const priceInput = document.querySelector(`.box-price[data-size='${size}']`);
    
    if (qtyInput && order[qtyField] !== undefined) {
      qtyInput.value = order[qtyField] || "0";
    }
    if (priceInput && order[priceField] !== undefined) {
      priceInput.value = order[priceField] || "0";
    }
  });

  // Cover data
  const coverSizes = ['small', 'medium', 'large'];
  
  coverSizes.forEach(size => {
    const qtyField = `cover_${size}_qty`;
    const priceField = `cover_${size}_price`;
    
    const qtyInput = document.querySelector(`.cover-qty[data-size='${size}']`);
    const priceInput = document.querySelector(`.cover-price[data-size='${size}']`);
    
    if (qtyInput && order[qtyField] !== undefined) {
      qtyInput.value = order[qtyField] || "0";
    }
    if (priceInput && order[priceField] !== undefined) {
      priceInput.value = order[priceField] || "0";
    }
  });
}

/* -------------------------
   Autocomplete Functionality
-------------------------*/
function createAutocomplete(inputId, endpoint, listKey, displayKey, valueKey, onSelectCallback = null) {
  const input = document.getElementById(inputId);
  if (!input) return;
  
  const wrapper = input.parentElement;
  let currentList;

  function removeCurrentList() {
    if (currentList) {
      currentList.remove();
      currentList = null;
    }
  }

  input.addEventListener("input", function () {
    const val = this.value.trim().toLowerCase();
    removeCurrentList();
    
    if (inputId === "companyName") {
      if (!this.dataset.selectedId || this.value !== this.dataset.originalValue) {
        isConsignerFromDropdown = false;
        updatePodNoField();
        updatePaymentOptions();
      }
    }
    
    if (!val) {
      if (inputId === "companyName") {
        isConsignerFromDropdown = false;
        updatePodNoField();
        updatePaymentOptions();
      }
      return;
    }

    const body = {
      app_id: localStorage.getItem("app_id") || "Mzk-",
      search: val,
      term: val
    };

    safeFetch(BASE_URL + endpoint, {
      method: "POST",
      body: JSON.stringify(body)
    })
    .then(r => r.json())
    .then(data => {
      let arr = data[listKey] || [];
      currentList = document.createElement("div");
      currentList.className = "autocomplete-items";
      wrapper.appendChild(currentList);

      if (arr.length === 0) {
        const noResults = document.createElement("div");
        noResults.className = "no-results";
        noResults.textContent = "No results found";
        currentList.appendChild(noResults);
        return;
      }

      arr.forEach(item => {
        const text = item[displayKey] || "";
        const id = item[valueKey] || "";

        if (text.toLowerCase().includes(val)) {
          const div = document.createElement("div");
          div.className = "autocomplete-item";
          div.textContent = text;

          div.onclick = () => {
            input.value = text;
            input.dataset.selectedId = id;
            input.dataset.originalValue = text;

            if (inputId === "companyName") {
              isConsignerFromDropdown = true;
              updatePodNoField();
              updatePaymentOptions();
            }

            if (onSelectCallback && typeof onSelectCallback === 'function') {
              onSelectCallback(item);
            }

            removeCurrentList();
          };

          currentList.appendChild(div);
        }
      });
    })
    .catch(err => {
      console.error('Error fetching data:', err);
    });
  });

  input.addEventListener("blur", function() {
    setTimeout(removeCurrentList, 150);
  });

  input.addEventListener('change', function() {
    if (inputId === "companyName") {
      if (this.dataset.selectedId && this.value !== this.dataset.originalValue) {
        isConsignerFromDropdown = false;
        delete this.dataset.selectedId;
        delete this.dataset.originalValue;
        updatePodNoField();
        updatePaymentOptions();
      }
    }
  });
}

function onConsignerSelect(selectedItem) {
  const cityInput = document.getElementById('city');
  const addressInput = document.getElementById('address');
  
  if (selectedItem.startsfrom && cityInput) {
    cityInput.value = selectedItem.startsfrom;
    cityInput.dataset.selectedId = selectedItem.stcompanyid || '';
  }
  
  if (selectedItem.address && addressInput) {
    addressInput.value = selectedItem.address;
  }
}

function onConsigneeSelect(selectedItem) {
  const cityInput = document.getElementById('cCity');
  const addressInput = document.getElementById('cAddress');
  const phoneInput = document.getElementById('cPhone');
  
  if (selectedItem.destination && cityInput) {
    cityInput.value = selectedItem.destination;
    cityInput.dataset.destinationid = selectedItem.destinationid || '';
  }
  
  if (selectedItem.dst_address && addressInput) {
    addressInput.value = selectedItem.dst_address;
  }
  
  if (selectedItem.dst_phone_number && phoneInput) {
    phoneInput.value = selectedItem.dst_phone_number;
  }
}

function initAutocomplete() {
  createAutocomplete(
    "companyName",
    "get_consigner.php",
    "consignordet",
    "company_name",
    "stcompanyid",
    onConsignerSelect
  );

  createAutocomplete(
    "city",
    "get_city.php",
    "citydet",
    "city_name",
    "cityid"
  );

  createAutocomplete(
    "cName",
    "get_consignee.php",
    "consigneedet",
    "dst_company_name",
    "dstcompanyid",
    onConsigneeSelect
  );

  createAutocomplete(
    "cCity",
    "get_city.php",
    "citydet",
    "city_name",
    "cityid"
  );
}

// Function to update POD No field validation
function updatePodNoField() {
  const podNoField = document.querySelector('.pod-no-field');
  const podNoInput = document.getElementById('podNo');
  
  if (!podNoField || !podNoInput) return;
  
  if (isConsignerFromDropdown) {
    podNoField.classList.add('optional');
    podNoInput.classList.remove('required-field');
    podNoInput.placeholder = "Optional when consigner selected from list";
  } else {
    podNoField.classList.remove('optional');
    podNoInput.classList.add('required-field');
    podNoInput.placeholder = "Enter POD No";
  }
}

// Function to update payment options based on consigner selection
function updatePaymentOptions() {
  const nonePaymentBox = document.getElementById('noneBox');
  
  if (!nonePaymentBox) return;
  
  if (isConsignerFromDropdown) {
    nonePaymentBox.classList.remove('payment-disabled');
    nonePaymentBox.style.cursor = 'pointer';
    nonePaymentBox.title = '';
  } else {
    nonePaymentBox.classList.add('payment-disabled');
    nonePaymentBox.style.cursor = 'not-allowed';
    nonePaymentBox.title = 'None payment only available when consigner is selected from dropdown';
    
    if (selectedPayment === 'none') {
      selectedPayment = null;
      nonePaymentBox.classList.remove('active');
    }
  }
}

/* -------------------------
   Payment Selection
-------------------------*/
function selectPayment(type) {
  if (type === 'none' && !isConsignerFromDropdown) {
    alert("None payment type is only available when consigner is selected from dropdown");
    return;
  }
  
  document.querySelectorAll(".payment-box").forEach(x => x.classList.remove("active"));
  document.getElementById(type + "Box").classList.add("active");
  selectedPayment = type;
  document.getElementById("paymentError").style.display = "none";
}

/* -------------------------
   Save Changes - UPDATED FOR EXACT API FORMAT
-------------------------*/
document.getElementById("saveButton").addEventListener("click", async () => {
  if (!currentOrderId) {
    alert("Order ID missing!");
    return;
  }

  // Validate required fields
  const requiredFields = document.querySelectorAll('.required-field');
  let isValid = true;
  
  requiredFields.forEach(field => {
    if (field.id === 'podNo' && isConsignerFromDropdown) {
      return;
    }
    
    const value = (field.value || '').trim();
    
    if (field.type === 'tel' && field.pattern) {
      const reg = new RegExp(`^${field.pattern}$`);
      if (!reg.test(value)) {
        field.classList.add('is-invalid-field');
        field.nextElementSibling.style.display = 'block';
        isValid = false;
        return;
      }
    }
    
    if (!value) {
      field.classList.add('is-invalid-field');
      field.nextElementSibling.style.display = 'block';
      isValid = false;
      return;
    }
    
    field.classList.remove('is-invalid-field');
    field.nextElementSibling.style.display = 'none';
  });

  if (!isValid) {
    alert('⚠️ Please correct highlighted fields.');
    return;
  }

  if (!selectedPayment) {
    document.getElementById('paymentError').style.display = 'block';
    alert('⚠️ Please select a payment type.');
    return;
  }

  // Collect box data
  const boxData = {};
  const boxSizes = ['small', 'medium', 'large'];
  
  boxSizes.forEach(size => {
    const qtyInput = document.querySelector(`.box-qty[data-size='${size}']`);
    const priceInput = document.querySelector(`.box-price[data-size='${size}']`);
    
    boxData[size] = {
      qty: parseInt(qtyInput?.value || 0),
      price: parseInt(priceInput?.value || 0)
    };
  });

  // Collect cover data
  const coverData = {};
  const coverSizes = ['small', 'medium', 'large'];
  
  coverSizes.forEach(size => {
    const qtyInput = document.querySelector(`.cover-qty[data-size='${size}']`);
    const priceInput = document.querySelector(`.cover-price[data-size='${size}']`);
    
    coverData[size] = {
      qty: parseInt(qtyInput?.value || 0),
      price: parseInt(priceInput?.value || 0)
    };
  });

  // Prepare the data in the exact format expected by your API
  const requestData = {
    app_id: localStorage.getItem("app_id"),
    ord_id: currentOrderId,
    consignor_name: document.getElementById("companyName").value,
    consignorId: document.getElementById("companyName").dataset.selectedId || "",
    supp_inv_no: document.getElementById("supplierInvoice").value,
    pod_no: document.getElementById("podNo").value,
    consignor_city: document.getElementById("city").value,
    consignor_cityId: document.getElementById("city").dataset.selectedId || "",
    consignor_address: document.getElementById("address").value,
    consignor_phone: document.getElementById("phone").value,
    consignee_name: document.getElementById("cName").value,
    consigneeId: document.getElementById("cName").dataset.selectedId || "",
    consignee_city: document.getElementById("cCity").value,
    consignee_cityId: document.getElementById("cCity").dataset.selectedId || document.getElementById("cCity").dataset.destinationid || "",
    route: document.getElementById("cRoute").value,
    consignee_phone: document.getElementById("cPhone").value,
    consignee_address: document.getElementById("cAddress").value,
    payment_type: selectedPayment,
    box_data: JSON.stringify(boxData),
    cover_data: JSON.stringify(coverData)
  };

  console.log("Sending data to API:", requestData);

  try {
    const response = await safeFetch(UPDATE_ORDER_API, {
      method: "POST",
      body: JSON.stringify(requestData)
    });

    const result = await response.json();
    console.log("API Response:", result);

    if (result.success || result.message) {
      alert(result.message || "Order Updated Successfully!");
      // Optionally redirect back to orders page
      // window.location.href = 'view_order.html';
    } else {
      alert("Update failed: " + (result.error || "Unknown error"));
    }
  } catch (err) {
    console.error("Error updating order:", err);
    alert("Failed to update order: " + err.message);
  }
});

/* -------------------------
   Back Button
-------------------------*/
document.getElementById("backButton").addEventListener("click", () => {
  window.location.href = "view_order.html";
});

/* -------------------------
   On Load
-------------------------*/
document.addEventListener("DOMContentLoaded", () => {
  currentOrderId = getOrderId();
  if (!currentOrderId) return showNoSelection();
  fetchOrder(currentOrderId);
});
</script>
</body>
</html>