<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>View Orders</title>

    <!-- Bootstrap -->
    <link
      href="../bootstrap-5.3.8-dist/bootstrap-5.3.8-dist/css/bootstrap.min.css"
      rel="stylesheet"
    />

    <!-- FontAwesome -->
    <link
      rel="stylesheet"
      href="../fontawesome-free-7.1.0-web/fontawesome-free-7.1.0-web/css/all.min.css"
    />
    <link rel="stylesheet" href="css/view_order.css">
  </head>

  <body>
    <!-- Header -->
<!-- Header -->
<div class="header shadow-sm fixed-top" id="header" style="background-color: #ffca1d; height:50px;">
  <div class="d-flex align-items-center px-2" style="height:50px;">
    <button id="backbtn" class="btn btn-link p-0 text-dark">
      <i class="fa-solid fa-arrow-left fs-6"></i>
    </button>
    <h6 class="mb-0 text-dark ms-2" style="font-size: 14px;">View Orders</h6>
  </div>
</div>




    <!-- Main -->
    <main class="container mt-3 mb-5">
      <div id="orderList"></div>

      <div class="loading-spinner" id="loadingSpinner">
        <div class="spinner-border text-primary"></div>
        <p class="mt-2">Loading orders...</p>
      </div>

      <div class="no-orders" id="noOrdersMessage" style="display: none">
        <i class="fa-solid fa-box-open fa-3x mb-2"></i>
        <h5>No Orders Found</h5>
      </div>
    </main>

    <!-- Pagination -->
    <div
      id="paginationContainer"
      class="pagination-container"
      style="display: none"
    >
      <button class="btn btn-outline-primary" id="prevBtn">◀ Previous</button>
      <span id="pageInfo"></span>
      <button class="btn btn-outline-primary" id="nextBtn">Next ▶</button>
    </div>

    <script>
      // Pagination
      const ORDERS_PER_PAGE = 15;
      let currentPage = 1;
      let totalPages = 0;
      let allOrders = [];
      localStorage.setItem("app_id", "Mzk-");

      document
        .getElementById("backbtn")
        .addEventListener("click", () => (location.href = "index.html"));

      document.addEventListener("DOMContentLoaded", () => loadOrders());

      async function loadOrders() {
        try {
          document.getElementById("loadingSpinner").style.display = "block";

          const response = await fetch(
            "https://www.loginlogistics.in/main/driverapp/my-orders.php",
            {
              method: "POST",
              headers: { "Content-Type": "application/json" },
              body: JSON.stringify({ app_id: localStorage.getItem("app_id") }),
            }
          );

          const data = await response.json();
          allOrders = transform(data);
          totalPages = Math.ceil(allOrders.length / ORDERS_PER_PAGE);

          if (allOrders.length === 0) {
            document.getElementById("noOrdersMessage").style.display = "block";
          } else {
            render();
            updatePagination();
          }
        } catch (e) {
          alert("Error loading orders");
        } finally {
          document.getElementById("loadingSpinner").style.display = "none";
        }
      }

      function transform(apiData) {
        if (Array.isArray(apiData)) return apiData.map((o) => format(o));
        if (apiData.allOrders) return apiData.allOrders.map((o) => format(o));
        if (apiData.data) return apiData.data.map((o) => format(o));
        return [];
      }

      function format(order) {
        return {
          id: order.ord_id || "",
          podNo: order.pod_no || "",
          consigner: order.consignor || "",
          consignee: order.consignee || "",
          stop: order.stop || "",
          route: order.route || "",
          date: order.add_date || "",
          paymentStatus:
            order.topay === "yes"
              ? "to-pay"
              : order.paid_order === "yes"
              ? "paid"
              : "none",
        };
      }

      function render() {
        const start = (currentPage - 1) * ORDERS_PER_PAGE;
        const current = allOrders.slice(start, start + ORDERS_PER_PAGE);
        let html = "";

        current.forEach((order) => {
          const payClass = getPayClass(order.paymentStatus);
          const payText = getPayText(order.paymentStatus);
          const payLabel =
           order.paymentStatus === "none"
              ? ""
              : `<span class="payment-status ${payClass}">${payText}</span>`;

          html += `
<div class="card shadow-sm row-12">
  <div class="card-body">
    <div class="order-row mt-2">

      <div class="pod-title">POD #${escape(order.podNo)}</div>
      ${payLabel}
    </div>

    <div class="order-row col-6">

      <div class="details-left">
        <p class="mb-1"><strong>Consignee:</strong> ${escape(
          order.consignee
        )}</p>
        <p class="mb-1"><strong>Consigner:</strong> ${escape(
          order.consigner
        )}</p>
        <p class="order-date text-muted"><i class="fa-solid fa-calendar"></i> ${formatDate(
          order.date
        )}</p>
      </div>

<div class="details-right" col-3>
  <div class="route-stop-container">
    <p class="mb-1 text"><strong>Route:</strong> ${escape(order.route)}</p>
    <p  class="mb-1"><strong>Stop:</strong> ${escape(order.stop)}</p>
  </div>
</div>

<div class="d-flex gap-1 justify-content-end  col-3 ">
  <button class="btn btn-secondary small-action-btn" onclick="editOrder('${
    order.id
  }')">
    <i class="fa-solid fa-pen"></i>
  </button>
  <button class="btn btn-primary small-action-btn" onclick="viewOrder('${
    order.id
  }')">
    <i class="fa-solid fa-eye"></i>
  </button>
</div>



    </div>
  </div>
</div>`;
        });

        document.getElementById("orderList").innerHTML = html;
      }

      function getPayClass(s) {
        return s === "paid"
          ? "text-success"
          : s === "to-pay"
          ? "text-warning"
          : "text-muted";
      }
      function getPayText(s) {
        return s === "paid" ? "Paid" : s === "to-pay" ? "To Pay" : "";
      }

      function updatePagination() {
        document.getElementById("paginationContainer").style.display = "flex";
        document.getElementById(
          "pageInfo"
        ).innerHTML = `Page ${currentPage} / ${totalPages}`;

        document.getElementById("prevBtn").onclick = () => {
          if (currentPage > 1) {
            currentPage--;
            render();
            updatePagination();
          }
        };
        document.getElementById("nextBtn").onclick = () => {
          if (currentPage < totalPages) {
            currentPage++;
            render();
            updatePagination();
          }
        };
      }

      function escape(str) {
        return (str || "").replace(/</g, "&lt;").replace(/>/g, "&gt;");
      }

      function formatDate(dateString) {
        if (!dateString) return "N/A";
        try {
          // Handle different date formats
          if (dateString.includes("/")) {
            const parts = dateString.split("/");
            if (parts.length === 3) {
              const date = new Date(parts[2], parts[1] - 1, parts[0]);
              if (!isNaN(date.getTime())) {
                return date.toLocaleDateString("en-US", {
                  year: "numeric",
                  month: "short",
                  day: "numeric",
                });
              }
            }
          }

          // Try parsing as ISO date
          const date = new Date(dateString);
          if (!isNaN(date.getTime())) {
            return date.toLocaleDateString("en-US", {
              year: "numeric",
              month: "short",
              day: "numeric",
            });
          }

          return dateString; // Return original if can't parse
        } catch (e) {
          return dateString; // Return original if error
        }
      }
      window.addEventListener("scroll", () => {
        const pagination = document.querySelector(".pagination-container");

        if (
          window.innerHeight + window.scrollY >=
          document.body.scrollHeight - 10
        ) {
          pagination.classList.add("show");
        } else {
          pagination.classList.remove("show");
        }
      });

      function viewOrder(id) {
        location.href = `view.html?orderId=${id}`;
      }
      function editOrder(id) {
        location.href = `order_edit.html?ord_id=${id}`;
      }
    </script>
  </body>
</html>
