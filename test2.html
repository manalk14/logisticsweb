<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Update Delivery Status</title>

<link href="../bootstrap-5.3.8-dist/bootstrap-5.3.8-dist/css/bootstrap.min.css" rel="stylesheet" />
<link rel="stylesheet" href="../fontawesome-free-7.1.0-web/fontawesome-free-7.1.0-web/css/all.min.css" />

<style>
.app-header {
  background-color: #ff7b00;
  padding: 15px 0;
  color: white;
}

.content-card {
  background: white;
  border-radius: 10px;
  padding: 20px;
  box-shadow: 0 2px 10px rgba(0,0,0,0.1);
  margin-bottom: 100px;
}

/* SIMPLE INFO */
.simple-info {
  font-size: 16px;
  color: #333;
  padding: 8px 0;
  border-bottom: 1px solid #e2e2e2;
}

.simple-info strong { font-weight: 600; color: #000; }

/* QUANTITY INPUTS */
.qty-card { background:#fff;border:1px solid #eee;padding:10px 12px;
  border-radius:8px;display:flex;justify-content:space-between;align-items:center; }
.qty-title { font-size:13px;font-weight:500;color:#444; }
.qty-input { width:70px;text-align:center;border:1px solid #ddd;border-radius:4px;
  padding:4px 8px;font-weight:bold;font-size:16px;color:#ff7b00; }

/* PAYMENT SECTION */
.payment-section {
  background:#f8f9fa;border-radius:8px;padding:15px;margin-top:15px;margin-bottom:15px;
  border-left:4px solid #28a745;
}
.payment-title {
  font-weight:600;color:#28a745;margin-bottom:10px;display:flex;align-items:center;gap:8px;
}
.payment-input-group { display:flex;align-items:center;gap:10px;margin-top:6px; }
.payment-input { flex:1;border:1px solid #ddd;border-radius:4px;padding:8px 12px;font-size:16px; }
.payment-currency { font-weight:bold;color:#28a745; }
.error-text { color:red;font-size:13px;margin-top:5px; }

/* FOOTER */
.fixed-footer {
  position:fixed;bottom:0;left:0;right:0;background:white;padding:12px;
  box-shadow:0 -2px 8px rgba(0,0,0,0.1);z-index:9999;
}
.btn-lg { background:#f39e00;color:white;padding:10px;border-radius:18px;width:100%;
  font-size:15px;font-weight:600;display:none; }
</style>
</head>

<body>
<header class="app-header mb-3">
  <div class="container d-flex align-items-center">
    <i class="fas fa-arrow-left fa-lg me-3" id="backButton" style="cursor:pointer;"></i>
    <h5 class="mb-0 fw-bold">Update Delivery Status</h5>
  </div>
</header>

<main class="container">
  <div class="content-card">

    <div class="text-center" id="loadingSpinner">
      <div class="spinner-border text-primary"></div>
      <p class="mt-2">Loading order details...</p>
    </div>

    <div class="error-message text-center text-danger fw-bold" id="errorMessage" style="display:none;">
      <i class="fas fa-exclamation-circle"></i> <span id="errorText"></span>
    </div>

    <form id="deliveryForm" style="display:none;">

      <div class="simple-info">
        <strong>POD No:</strong> <span id="podDisplay">-</span>
      </div>

      <div class="simple-info">
        <strong>Payment Type:</strong> <span id="paymentTypeDisplay">-</span>
      </div>

      <!-- QUANTITIES -->
      <label class="mt-3 mb-2 fw-semibold">Order Quantities</label>
      <div class="row g-2">

        <div class="col-6"><div class="qty-card">
          <span class="qty-title">Small Box</span>
          <input type="number" class="qty-input" id="smallBoxQty" value="0" min="0">
        </div></div>

        <div class="col-6"><div class="qty-card">
          <span class="qty-title">Medium Box</span>
          <input type="number" class="qty-input" id="mediumBoxQty" value="0" min="0">
        </div></div>

        <div class="col-6"><div class="qty-card">
          <span class="qty-title">Large Box</span>
          <input type="number" class="qty-input" id="largeBoxQty" value="0" min="0">
        </div></div>

        <div class="col-6"><div class="qty-card">
          <span class="qty-title">Small Cover</span>
          <input type="number" class="qty-input" id="smallCoverQty" value="0" min="0">
        </div></div>

        <div class="col-6"><div class="qty-card">
          <span class="qty-title">Medium Cover</span>
          <input type="number" class="qty-input" id="mediumCoverQty" value="0" min="0">
        </div></div>

        <div class="col-6"><div class="qty-card">
          <span class="qty-title">Large Cover</span>
          <input type="number" class="qty-input" id="largeCoverQty" value="0" min="0">
        </div></div>

      </div>

      <!-- PAYMENT SECTION -->
      <div class="payment-section" id="paymentSection" style="display:none;">
        <div class="payment-title">
          <i class="fas fa-money-bill-wave"></i> Payment Collection
        </div>

        <p class="fw-semibold">Total Amount: ₹ <span id="totalAmountDisplay">0</span></p>

        <div class="payment-input-group">
          <span class="payment-currency">₹</span>
          <input type="number" id="receivedAmount" class="payment-input" placeholder="Enter received amount" min="0">
        </div>
        <div id="receivedError" class="error-text" style="display:none;">Enter valid amount</div>
      </div>

      <textarea id="deliveryNotes" rows="3" class="form-control mb-3" placeholder="Delivery notes"></textarea>

      <div class="image-upload mb-2" id="imageUpload">
        <i class="fas fa-camera fa-2x"></i>
        <p>Tap to upload proof image</p>
      </div>

      <div class="existing-image text-center" style="display:none;">
        <img id="proofImage" alt="Proof">
      </div>

      <input type="file" id="imageInput" accept="image/*" style="display:none;">

    </form>
  </div>
</main>

<footer class="fixed-footer">
  <button id="saveButton" class="btn btn-lg">Save</button>
</footer>

<script>
const APP_ID = "Mzk-";
let proofImageSelected = false;
let totalAmount = 0;

document.getElementById("backButton").addEventListener("click",()=>{ 
  window.location.href="delivery_status.html";
});

document.addEventListener("DOMContentLoaded",()=>{
  const orderId = localStorage.getItem("selectedOrderId");
  if(!orderId) return showError("No order selected");
  fetchOrderDetails(orderId);

  document.getElementById("saveButton").addEventListener("click", validateForm);

  // IMAGE UPLOAD WORKING FIX
  const imageInput = document.getElementById("imageInput");
  document.getElementById("imageUpload").addEventListener("click",()=>imageInput.click());

  imageInput.addEventListener("change",()=>{
    if(imageInput.files.length > 0){
      proofImageSelected = true;
      const reader = new FileReader();
      reader.onload=e=>{
        document.getElementById("proofImage").src=e.target.result;
        document.querySelector(".existing-image").style.display="block";
      };
      reader.readAsDataURL(imageInput.files[0]);
    }
  });
});

function showForm(){
  document.getElementById("loadingSpinner").style.display="none";
  document.getElementById("deliveryForm").style.display="block";
  document.getElementById("saveButton").style.display="block";
}

function showError(msg){
  document.getElementById("loadingSpinner").style.display="none";
  document.getElementById("errorMessage").style.display="block";
  document.getElementById("errorText").textContent = msg;
}

async function fetchOrderDetails(orderId){
  try{
    const res = await fetch("https://www.loginlogistics.in/main/driverapp/get_delivery_order_details.php",{
      method:"POST",
      headers:{ "Content-Type":"application/json"},
      body:JSON.stringify({ ord_id:orderId, app_id:APP_ID })
    });

    const data = await res.json();
    if(data.result==="1"){

      // POD + payment
      document.getElementById("podDisplay").textContent = data.pod_no ?? "N/A";
      document.getElementById("paymentTypeDisplay").textContent = formatPaymentType(data.payment_type);

      // QUANTITY FIX
      document.getElementById("smallBoxQty").value = data.box_small_qty ?? "0";
      document.getElementById("mediumBoxQty").value = data.box_medium_qty ?? "0";
      document.getElementById("largeBoxQty").value = data.box_large_qty ?? "0";
      document.getElementById("smallCoverQty").value = data.cover_small_qty ?? "0";
      document.getElementById("mediumCoverQty").value = data.cover_medium_qty ?? "0";
      document.getElementById("largeCoverQty").value = data.cover_large_qty ?? "0";

      // PAYMENT SECTION
      totalAmount = parseFloat((data.total_amount || "0").replace(/,/g,"")) || 0;
      document.getElementById("totalAmountDisplay").textContent = data.total_amount || "0.00";

      if(data.payment_type.toLowerCase()==="topay" || data.payment_type.toLowerCase()==="to pay"){
        document.getElementById("paymentSection").style.display="block";
      }

      showForm();
    } else {
      showError("Failed to load details");
    }

  }catch(err){
    showError("Network error");
  }
}

// PAYMENT TYPE FORMATTER
function formatPaymentType(v){
  if(!v) return "-";
  v = v.toLowerCase();
  if(v==="topay"||v==="to-pay") return "To Pay";
  return v.charAt(0).toUpperCase()+v.slice(1);
}

function validateForm(){
  const received = parseFloat(document.getElementById("receivedAmount").value);

  if(document.getElementById("paymentTypeDisplay").textContent==="To Pay"){
    if(!received || received <= 0 || received > totalAmount){
      document.getElementById("receivedError").style.display="block";
      return;
    } else {
      document.getElementById("receivedError").style.display="none";
    }
  }

  if(!proofImageSelected){
    alert("Proof image required");
    return;
  }

  alert("Delivery status saved successfully!");
}
</script>


</body>
</html>
