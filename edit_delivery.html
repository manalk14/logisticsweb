<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Update Delivery Status</title>

<link href="../bootstrap-5.3.8-dist/bootstrap-5.3.8-dist/css/bootstrap.min.css" rel="stylesheet" />
<link rel="stylesheet" href="../fontawesome-free-7.1.0-web/fontawesome-free-7.1.0-web/css/all.min.css" />

<style>
.app-header {
  background-color: #ffca1d;
  width: 100%;
  padding: 10px 0;
}

.content-card {
  background: white;
  border-radius: 10px;
  padding: 20px;
  box-shadow: 0 2px 10px rgba(0,0,0,0.1);
  margin-bottom: 100px;
}

/* SIMPLE INFO UI */
.simple-info {
  font-size: 16px;
  color: #333;
  padding: 8px 0;
  border-bottom: 1px solid #e2e2e2;
}

.simple-info strong {
  font-weight: 600;
  color: #000;
}

/* QUANTITY SECTION */
.qty-grid { margin-bottom: 20px; }

.qty-card {
  background: #ffffff;
  border: 1px solid #eee;
  padding: 10px 12px;
  border-radius: 8px;
  display: flex;
  justify-content: space-between;
  align-items: center;
}

.qty-title {
  font-size: 13px;
  font-weight: 500;
  color: #444;
}

.qty-input {
  width: 70px;
  text-align: center;
  border: 1px solid #ddd;
  border-radius: 4px;
  padding: 4px 8px;
  font-weight: bold;
  font-size: 16px;
  color: #000000;
}

/* STATUS OPTIONS */
.status-options {
  display: flex;
  gap: 15px;
  margin-bottom: 20px;
}

.status-option {
  flex: 1;
  padding: 15px;
  border: 2px solid #ddd;
  border-radius: 8px;
  text-align: center;
  cursor: pointer;
}

.status-option.selected {
  border-color: #ffca1d;
  background-color: #fff5e6;
}

.image-upload {
  border: 2px dashed #ddd;
  border-radius: 8px;
  padding: 30px;
  text-align: center;
  cursor: pointer;
}

.existing-image img {
  max-width: 100%;
  max-height: 200px;
  border-radius: 8px;
}

.fixed-footer {
  position: fixed;
  bottom: 0;
  left: 0;
  right: 0;
  background: white;
  padding: 12px;
  box-shadow: 0 -2px 8px rgba(0,0,0,0.1);
  z-index: 9999;
}

main.container {
  padding-bottom: 120px;
}

.btn-lg {
  background-color: #ffca1d;
  color: white;
  padding: 10px 22px;
  border-radius: 18px;
  font-size: 15px;
  font-weight: 600;
  width: 100%;
  max-width: 450px;
  margin: 0 auto;
  display: none;
}

/* PAYMENT SECTION */
.payment-section {
  background: #f8f9fa;
  border-radius: 8px;
  padding: 15px;
  margin-top: 15px;
  margin-bottom: 15px;
  border-left: 4px solid  #ffc107;
}

.payment-title {
  font-weight: 600;
  color: #050505;
  margin-bottom: 10px;
  display: flex;
  align-items: center;
  gap: 8px;
}

.payment-input-group {
  display: flex;
  align-items: center;
  gap: 10px;
}

.payment-input {
  flex: 1;
  border: 1px solid #ddd;
  border-radius: 4px;
  padding: 8px 12px;
  font-size: 16px;
}

.payment-input:disabled {
  background-color: #e9ecef;
  color: #6c757d;
  cursor: not-allowed;
}

.payment-currency {
  font-weight: bold;
  color: #ffa42d;
}

.error-text {
  color: red;
  font-size: 13px;
  margin-top: 5px;
}

.payment-disabled-note {
  color: #6c757d;
  font-size: 14px;
  font-style: italic;
  margin-top: 8px;
}

.image-preview-container {
  margin-top: 10px;
  text-align: center;
}

.image-preview {
  max-width: 100%;
  max-height: 200px;
  border-radius: 8px;
  display: none;
}

/* Success Message Styles */
.success-message {
  position: fixed;
  top: 50%;
  left: 50%;
  transform: translate(-50%, -50%);
  background: #d4edda;
  color: #155724;
  padding: 20px 30px;
  border-radius: 10px;
  border: 1px solid #c3e6cb;
  box-shadow: 0 4px 15px rgba(0,0,0,0.2);
  z-index: 10000;
  text-align: center;
  display: none;
}

.success-message i {
  font-size: 40px;
  margin-bottom: 10px;
  display: block;
}

.success-message h5 {
  margin-bottom: 10px;
  font-weight: 600;
}

.success-overlay {
  position: fixed;
  top: 0;
  left: 0;
  right: 0;
  bottom: 0;
  background: rgba(0,0,0,0.5);
  z-index: 9999;
  display: none;
}

/* Smaller on small screens */
@media (max-width: 480px) {
  .btn-lg {
    padding: 8px 18px;
    font-size: 14px;
    border-radius: 15px;
  }
  
  .qty-input {
    width: 60px;
  }
  
  .success-message {
    width: 90%;
    padding: 15px 20px;
  }
}
</style>
</head>

<body>

<!-- Success Overlay -->
<div class="success-overlay" id="successOverlay"></div>

<!-- Success Message -->
<div class="success-message" id="successMessage">
  <i class="fas fa-check-circle"></i>
  <h5>Successfully Updated!</h5>
  <p>Delivery status has been updated successfully.</p>
  <small>Redirecting back to orders...</small>
</div>

<!-- HEADER -->
<header class="app-header w-100">
  <div class="d-flex align-items-center px-3" style="width:100%;">
    <i class="fas fa-arrow-left fa-lg me-3" id="backButton" style="cursor:pointer;"></i>
    <h5 class="mb-0 fw-bold">Update Delivery Status</h5>
  </div>
</header>

<main class="container">
  <div class="content-card">

    <!-- LOADING -->
    <div class="text-center" id="loadingSpinner">
      <div class="spinner-border text-primary"></div>
      <p class="mt-2">Loading order details...</p>
    </div>

    <!-- ERROR -->
    <div class="error-message text-center text-danger fw-bold" id="errorMessage" style="display:none;">
      <i class="fas fa-exclamation-circle"></i> <span id="errorText"></span>
    </div>

    <form id="deliveryForm" style="display:none;">

      <!-- SIMPLE POD + PAYMENT -->
      <div class="simple-info">
        <strong>POD No:</strong> <span id="podDisplay">-</span>
      </div>

      <div class="simple-info">
        <strong>Payment Type:</strong> <span id="paymentTypeDisplay">-</span>
      </div>

      <!-- QUANTITY -->
      <label class="mt-3 mb-2 fw-semibold">Order Quantities</label>
      <div class="row g-2 qty-grid">
        <!-- Box Quantities -->
        <div class="col-6">
          <div class="qty-card">
            <span class="qty-title">Small Box</span>
            <input type="number" class="qty-input" id="smallBoxQty" value="0" min="0">
          </div>
        </div>
        
        <div class="col-6">
          <div class="qty-card">
            <span class="qty-title">Medium Box</span>
            <input type="number" class="qty-input" id="mediumBoxQty" value="0" min="0">
          </div>
        </div>
        
        <div class="col-6">
          <div class="qty-card">
            <span class="qty-title">Large Box</span>
            <input type="number" class="qty-input" id="largeBoxQty" value="0" min="0">
          </div>
        </div>

        <!-- Cover Quantities -->
        <div class="col-6">
          <div class="qty-card">
            <span class="qty-title">Small Cover</span>
            <input type="number" class="qty-input" id="smallCoverQty" value="0" min="0">
          </div>
        </div>
        
        <div class="col-6">
          <div class="qty-card">
            <span class="qty-title">Medium Cover</span>
            <input type="number" class="qty-input" id="mediumCoverQty" value="0" min="0">
          </div>
        </div>
        
        <div class="col-6">
          <div class="qty-card">
            <span class="qty-title">Large Cover</span>
            <input type="number" class="qty-input" id="largeCoverQty" value="0" min="0">
          </div>
        </div>
      </div>

      <!-- PAYMENT COLLECTION SECTION -->
      <div class="payment-section" id="paymentSection">
        <div class="payment-title">
          <i class="fas fa-money-bill-wave"></i>
          <span>Payment Collection</span>
        </div>

        <p class="fw-semibold mb-1">
          Total Amount: â‚¹<span id="totalAmountDisplay">0.00</span>
        </p>

        <div class="payment-input-group mt-2">
          <span class="payment-currency">â‚¹</span>
          <input
            type="number"
            id="receivedAmount"
            class="payment-input"
            placeholder="Enter received amount"
            min="0"
            step="0.01"
            disabled
          >
        </div>
        <div id="receivedError" class="error-text" style="display:none;"></div>
        
        <!-- Dynamic message based on payment type -->
        <div id="paymentMessage" class="payment-disabled-note">
          Payment collection is not required for this order type.
        </div>
      </div>

      <!-- NOTES -->
      <textarea id="deliveryNotes" rows="3" class="form-control mb-3" placeholder="Delivery notes"></textarea>

      <!-- IMAGE -->
      <div class="image-upload mb-2" id="imageUpload">
        <i class="fas fa-camera fa-2x"></i>
        <p>Tap to upload proof image</p>
      </div>

      <div class="image-preview-container">
        <img id="proofImage" class="image-preview" alt="Proof Image Preview">
      </div>

      <input type="file" id="imageInput" accept="image/*" style="display:none;">

    </form>
  </div>
</main>

<footer class="fixed-footer">
  <button id="saveButton" class="btn btn-lg w-100" style="display:none;">Save</button>
</footer>

<script>
const APP_ID = "Mzk-";
let proofImageBase64 = "";
let currentOrderData = null;
let totalAmount = 0;

document.getElementById("backButton").addEventListener("click",()=>{ 
  window.location.href="delivery_status.html";
});

document.addEventListener("DOMContentLoaded",()=>{
  const notesInput = document.getElementById("deliveryNotes");
  const saveBtn = document.getElementById("saveButton");
  const imageInput = document.getElementById("imageInput");
  const errorNotes = document.createElement("div");
  const errorImage = document.createElement("div");

  // Insert message elements below fields
  errorNotes.style.color = "red";
  errorNotes.style.fontSize = "13px";
  errorNotes.style.marginTop = "4px";
  errorNotes.style.display = "none";
  notesInput.insertAdjacentElement("afterend", errorNotes);

  errorImage.style.color = "red";
  errorImage.style.fontSize = "13px";
  errorImage.style.textAlign = "center";
  errorImage.style.marginTop = "-10px";
  errorImage.style.display = "none";
  document.getElementById("imageUpload").insertAdjacentElement("afterend", errorImage);

  // Image upload handling
  document.getElementById("imageUpload").addEventListener("click",()=>imageInput.click());

  imageInput.addEventListener("change", () => {
    if (imageInput.files.length > 0) {
      const file = imageInput.files[0];
      
      // Check file size (limit to 2MB to avoid large payloads)
      if (file.size > 2 * 1024 * 1024) {
        errorImage.textContent = "Image size should be less than 2MB";
        errorImage.style.display = "block";
        document.getElementById("imageUpload").style.borderColor = "red";
        return;
      }

      const reader = new FileReader();
      reader.onload = e => {
        // Store the full data URL for preview
        const fullDataUrl = e.target.result;
        
        // Extract just the base64 part (remove "data:image/jpeg;base64," prefix)
        proofImageBase64 = fullDataUrl.split(',')[1];
        
        // Show preview with full data URL
        document.getElementById("proofImage").src = fullDataUrl;
        document.getElementById("proofImage").style.display = "block";

        // Clear any errors
        errorImage.style.display = "none";
        document.getElementById("imageUpload").style.borderColor = "#ddd";
        
        console.log("Image loaded successfully. Base64 length:", proofImageBase64.length);
      };
      
      reader.onerror = () => {
        errorImage.textContent = "Error reading image file";
        errorImage.style.display = "block";
        document.getElementById("imageUpload").style.borderColor = "red";
      };
      
      reader.readAsDataURL(file);
    }
  });

  // Save Button Validation
  saveBtn.addEventListener("click",()=>{
    let valid = true;

    // Notes validation
    if(notesInput.value.trim()===""){
      notesInput.style.borderColor = "red";
      errorNotes.textContent = "Notes required";
      errorNotes.style.display = "block";
      valid = false;
    } else {
      notesInput.style.borderColor = "#ccc";
      errorNotes.style.display = "none";
    }

    // Image validation
    if(!proofImageBase64){
      errorImage.textContent = "Proof image required";
      errorImage.style.display = "block";
      document.getElementById("imageUpload").style.borderColor = "red";
      valid = false;
    } else {
      errorImage.style.display = "none";
      document.getElementById("imageUpload").style.borderColor = "#ddd";
    }

    // Payment validation ONLY for "To Pay" orders
    const paymentTypeText = document.getElementById("paymentTypeDisplay").textContent.trim();
    const receivedError = document.getElementById("receivedError");
    receivedError.style.display = "none";
    receivedError.textContent = "";

    if (paymentTypeText === "To Pay") {
      const receivedStr = document.getElementById("receivedAmount").value;
      const received = parseFloat(receivedStr);

      if (!receivedStr || isNaN(received) || received <= 0) {
        receivedError.textContent = "Please enter a valid amount greater than 0";
        receivedError.style.display = "block";
        document.getElementById("receivedAmount").style.borderColor = "red";
        valid = false;
      } else if (received > totalAmount) {
        receivedError.textContent = "Received amount cannot be more than total amount";
        receivedError.style.display = "block";
        document.getElementById("receivedAmount").style.borderColor = "red";
        valid = false;
      } else {
        document.getElementById("receivedAmount").style.borderColor = "#ddd";
      }
    }

    if(valid){
      saveDeliveryStatus();
    }
  });

  // Load the selected order
  const orderId = localStorage.getItem("selectedOrderId");
  if(!orderId) return showError("No order selected");
  fetchOrderDetails(orderId);
});

function showForm(){
  document.getElementById("loadingSpinner").style.display="none";
  document.getElementById("deliveryForm").style.display="block";
  document.getElementById("saveButton").style.display="block";
}

function showError(msg){
  document.getElementById("loadingSpinner").style.display="none";
  document.getElementById("errorMessage").style.display="block";
  document.getElementById("errorText").textContent = msg;
}

// Show success message and redirect
function showSuccessAndRedirect() {
  const successOverlay = document.getElementById("successOverlay");
  const successMessage = document.getElementById("successMessage");
  
  // Show success message
  successOverlay.style.display = "block";
  successMessage.style.display = "block";
  
  // Redirect after 2 seconds
  setTimeout(() => {
    window.location.href = "delivery_status.html";
  }, 2000);
}

// Format payment type (topay -> To Pay, etc.)
function formatPaymentType(v){
  if(!v) return "-";
  v = v.toLowerCase();
  if(v === "topay" || v === "to-pay" || v === "to pay") return "To Pay";
  if(v === "paidorder" || v === "paid_order" || v === "paid order") return "Paid Order";
  if(v === "none") return "None";
  return v.charAt(0).toUpperCase() + v.slice(1);
}

// Function to handle payment section based on payment type
function setupPaymentSection(paymentType) {
  const receivedAmountInput = document.getElementById("receivedAmount");
  const paymentMessage = document.getElementById("paymentMessage");
  
  if (paymentType === "To Pay") {
    // Enable input for To Pay orders
    receivedAmountInput.disabled = false;
    receivedAmountInput.placeholder = "Enter received amount";
    paymentMessage.textContent = "Please enter the amount received from the consignee";
    paymentMessage.style.color = "#0d6efd";
  } else if (paymentType === "Paid Order") {
    // Disable input and show message for Paid orders
    receivedAmountInput.disabled = true;
    receivedAmountInput.placeholder = "Payment already received";
    receivedAmountInput.value = "";
    paymentMessage.textContent = "This order is already paid. No payment collection required.";
    paymentMessage.style.color = "#198754";
  } else {
    // Disable input and show message for None/other types
    receivedAmountInput.disabled = true;
    receivedAmountInput.placeholder = "Payment not required";
    receivedAmountInput.value = "";
    paymentMessage.textContent = "Payment collection is not required for this order type.";
    paymentMessage.style.color = "#6c757d";
  }
}

async function fetchOrderDetails(orderId){
  try{
    const res = await fetch("https://www.loginlogistics.in/main/driverapp/get_delivery_order_details.php",{
      method:"POST",
      headers:{ "Content-Type":"application/json"},
      body:JSON.stringify({ ord_id:orderId, app_id:APP_ID })
    });

    const data = await res.json();

    if(data.result === "1"){
      currentOrderData = data;
      
      document.getElementById("podDisplay").textContent = data.pod_no || "N/A";
      
      const formattedPaymentType = formatPaymentType(data.payment_type);
      document.getElementById("paymentTypeDisplay").textContent = formattedPaymentType;

      // Setup payment section based on payment type
      setupPaymentSection(formattedPaymentType);

      // After setting the quantity fields from API
      document.getElementById("smallBoxQty").value = data.box_small_qty || "0";
      document.getElementById("mediumBoxQty").value = data.box_medium_qty || "0";
      document.getElementById("largeBoxQty").value = data.box_large_qty || "0";
      document.getElementById("smallCoverQty").value = data.cover_small_qty || "0";
      document.getElementById("mediumCoverQty").value = data.cover_medium_qty || "0";
      document.getElementById("largeCoverQty").value = data.cover_large_qty || "0";

      // Set max = original quantity so cannot increase
      ["smallBoxQty","mediumBoxQty","largeBoxQty",
       "smallCoverQty","mediumCoverQty","largeCoverQty"].forEach(id=>{
        const input = document.getElementById(id);
        const original = parseInt(input.value) || 0;
        input.setAttribute("max", original);
        input.addEventListener("input", function(){
            let val = parseInt(input.value) || 0;
            if(val > original) input.value = original;   // restrict increase
            if(val < 0) input.value = 0;                // restrict negatives
        });
      });

      // Total amount from API: "5,300.00"
      const totalRaw = data.total_amount || "0.00";
      document.getElementById("totalAmountDisplay").textContent = totalRaw;
      totalAmount = parseFloat(totalRaw.replace(/,/g,"")) || 0;

      showForm();
    } else {
      showError("Failed to load order details");
    }

  }catch(err){
    console.error(err);
    showError("Network error");
  }
}

async function saveDeliveryStatus() {
  try {
    const orderId = localStorage.getItem("selectedOrderId");
    const notes = document.getElementById("deliveryNotes").value;

    const quantities = {
      box_small: document.getElementById("smallBoxQty").value || "0",
      box_medium: document.getElementById("mediumBoxQty").value || "0",
      box_large: document.getElementById("largeBoxQty").value || "0",
      cover_small: document.getElementById("smallCoverQty").value || "0",
      cover_medium: document.getElementById("mediumCoverQty").value || "0",
      cover_large: document.getElementById("largeCoverQty").value || "0"
    };

    const paymentTypeText = document.getElementById("paymentTypeDisplay").textContent.trim();
    let receivedAmount = "";

    // Only get received amount for To Pay orders
    if(paymentTypeText === "To Pay"){
      receivedAmount = document.getElementById("receivedAmount").value || "0";
    }

    // Prepare JSON data
    const jsonData = {
      ord_id: orderId,
      notes: notes,
      app_id: APP_ID,
      box_small: quantities.box_small,
      box_medium: quantities.box_medium,
      box_large: quantities.box_large,
      cover_small: quantities.cover_small,
      cover_medium: quantities.cover_medium,
      cover_large: quantities.cover_large
    };

    // Add received amount only for To Pay orders
    if(paymentTypeText === "To Pay"){
      jsonData.received_amount = receivedAmount;
    }

    // Add base64 image (just the base64 part, without data URL prefix)
    if(proofImageBase64){
      jsonData.proof_image = proofImageBase64;
      console.log("Image base64 length:", proofImageBase64.length);
      console.log("Image base64 first 100 chars:", proofImageBase64.substring(0, 100));
    } else {
      console.log("No image selected");
    }

    // ðŸ”¥ Print JSON data to console (without the full base64 to avoid console clutter)
    const debugData = {...jsonData};
    if(debugData.proof_image) {
      debugData.proof_image = "BASE64_IMAGE_DATA..." + debugData.proof_image.substring(debugData.proof_image.length - 50);
    }
    console.log("JSON Data being sent:");
    console.log(JSON.stringify(debugData, null, 2));

    // Send as JSON
    const response = await fetch("https://www.loginlogistics.in/main/driverapp/action/update-delivery.php", {
      method: "POST",
      headers: {
        "Content-Type": "application/json"
      },
      body: JSON.stringify(jsonData)
    });

    const result = await response.json();
    console.log("API Response:", result);

    // Handle different response formats
    if (result.success || result.result === "1" || result.status === "success") {
      showSuccessAndRedirect();
    } else {
      const errorMessage = result.message || result.error || "Unknown error occurred";
      alert("Failed to update delivery status: " + errorMessage);
    }

  } catch (error) {
    console.error("Error saving delivery status:", error);
    alert("Error saving delivery status. Please try again.");
  }
}
</script>

</body>
</html>