<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Update Delivery Status</title>

<link href="../bootstrap-5.3.8-dist/bootstrap-5.3.8-dist/css/bootstrap.min.css" rel="stylesheet" />
<link rel="stylesheet" href="../fontawesome-free-7.1.0-web/fontawesome-free-7.1.0-web/css/all.min.css" />

<style>
.app-header {
  background-color: #ff7b00;
  padding: 15px 0;
  color: rgb(0, 0, 0);
}

.content-card {
  background: white;
  border-radius: 10px;
  padding: 20px;
  box-shadow: 0 2px 10px rgba(0,0,0,0.1);
  margin-bottom: 100px;
}

/* SIMPLE INFO UI */
.simple-info {
  font-size: 16px;
  color: #333;
  padding: 8px 0;
  border-bottom: 1px solid #e2e2e2;
}

.simple-info strong {
  font-weight: 600;
  color: #000;
}

/* QUANTITY SECTION */
.qty-grid { margin-bottom: 20px; }

.qty-card {
  background: #ffffff;
  border: 1px solid #eee;
  padding: 10px 12px;
  border-radius: 8px;
  display: flex;
  justify-content: space-between;
  align-items: center;
}

.qty-title {
  font-size: 13px;
  font-weight: 500;
  color: #444;
}

.qty-input {
  width: 70px;
  text-align: center;
  border: 1px solid #ddd;
  border-radius: 4px;
  padding: 4px 8px;
  font-weight: bold;
  font-size: 16px;
  color: #ff7b00;
}

/* STATUS OPTIONS */
.status-options {
  display: flex;
  gap: 15px;
  margin-bottom: 20px;
}

.status-option {
  flex: 1;
  padding: 15px;
  border: 2px solid #ddd;
  border-radius: 8px;
  text-align: center;
  cursor: pointer;
}

.status-option.selected {
  border-color: #ff7b00;
  background-color: #fff5e6;
}

.image-upload {
  border: 2px dashed #ddd;
  border-radius: 8px;
  padding: 30px;
  text-align: center;
  cursor: pointer;
}

.existing-image img {
  max-width: 100%;
  max-height: 200px;
  border-radius: 8px;
}

.fixed-footer {
  position: fixed;
  bottom: 0;
  left: 0;
  right: 0;
  background: white;
  padding: 12px;
  box-shadow: 0 -2px 8px rgba(0,0,0,0.1);
  z-index: 9999;
}

main.container {
  padding-bottom: 120px;
}

.btn-lg {
  background-color: #f39e00;
  color: white;
  padding: 10px 22px;
  border-radius: 18px;
  font-size: 15px;
  font-weight: 600;
  width: 100%;
  max-width: 450px;
  margin: 0 auto;
  display: none;
}

/* PAYMENT SECTION */
.payment-section {
  background: #f8f9fa;
  border-radius: 8px;
  padding: 15px;
  margin-top: 15px;
  margin-bottom: 15px;
  border-left: 4px solid  #ffc107;
}

.payment-title {
  font-weight: 600;
  color: #ffc107;
  margin-bottom: 10px;
  display: flex;
  align-items: center;
  gap: 8px;
}

.payment-input-group {
  display: flex;
  align-items: center;
  gap: 10px;
}

.payment-input {
  flex: 1;
  border: 1px solid #ddd;
  border-radius: 4px;
  padding: 8px 12px;
  font-size: 16px;
}

.payment-currency {
  font-weight: bold;
  color: #ffa42d;
}

.error-text {
  color: red;
  font-size: 13px;
  margin-top: 5px;
}

/* Smaller on small screens */
@media (max-width: 480px) {
  .btn-lg {
    padding: 8px 18px;
    font-size: 14px;
    border-radius: 15px;
  }
  
  .qty-input {
    width: 60px;
  }
}
</style>
</head>

<body>

<!-- HEADER -->
<header class="app-header mb-3">
  <div class="container d-flex align-items-center">
    <i class="fas fa-arrow-left fa-lg me-3" id="backButton" style="cursor:pointer;"></i>
    <h5 class="mb-0 fw-bold">Update Delivery Status</h5>
  </div>
</header>

<main class="container">
  <div class="content-card">

    <!-- LOADING -->
    <div class="text-center" id="loadingSpinner">
      <div class="spinner-border text-primary"></div>
      <p class="mt-2">Loading order details...</p>
    </div>

    <!-- ERROR -->
    <div class="error-message text-center text-danger fw-bold" id="errorMessage" style="display:none;">
      <i class="fas fa-exclamation-circle"></i> <span id="errorText"></span>
    </div>

    <form id="deliveryForm" style="display:none;">

      <!-- SIMPLE POD + PAYMENT -->
      <div class="simple-info">
        <strong>POD No:</strong> <span id="podDisplay">-</span>
      </div>

      <div class="simple-info">
        <strong>Payment Type:</strong> <span id="paymentTypeDisplay">-</span>
      </div>

      <!-- QUANTITY -->
      <label class="mt-3 mb-2 fw-semibold">Order Quantities</label>
      <div class="row g-2 qty-grid">
        <!-- Box Quantities -->
        <div class="col-6">
          <div class="qty-card">
            <span class="qty-title">Small Box</span>
            <input type="number" class="qty-input" id="smallBoxQty" value="0" min="0">
          </div>
        </div>
        
        <div class="col-6">
          <div class="qty-card">
            <span class="qty-title">Medium Box</span>
            <input type="number" class="qty-input" id="mediumBoxQty" value="0" min="0">
          </div>
        </div>
        
        <div class="col-6">
          <div class="qty-card">
            <span class="qty-title">Large Box</span>
            <input type="number" class="qty-input" id="largeBoxQty" value="0" min="0">
          </div>
        </div>

        <!-- Cover Quantities -->
        <div class="col-6">
          <div class="qty-card">
            <span class="qty-title">Small Cover</span>
            <input type="number" class="qty-input" id="smallCoverQty" value="0" min="0">
          </div>
        </div>
        
        <div class="col-6">
          <div class="qty-card">
            <span class="qty-title">Medium Cover</span>
            <input type="number" class="qty-input" id="mediumCoverQty" value="0" min="0">
          </div>
        </div>
        
        <div class="col-6">
          <div class="qty-card">
            <span class="qty-title">Large Cover</span>
            <input type="number" class="qty-input" id="largeCoverQty" value="0" min="0">
          </div>
        </div>
      </div>

      <!-- PAYMENT COLLECTION SECTION (For To Pay orders) -->
      <div class="payment-section" id="paymentSection" style="display:none;">
        <div class="payment-title">
          <i class="fas fa-money-bill-wave"></i>
          <span>Payment Collection</span>
        </div>

        <p class="fw-semibold mb-1">
          Total Amount: ₹<span id="totalAmountDisplay">0.00</span>
        </p>

        <div class="payment-input-group mt-2">
          <span class="payment-currency">₹</span>
          <input
            type="number"
            id="receivedAmount"
            class="payment-input"
            placeholder="Enter received amount"
            min="0"
            step="0.01"
          >
        </div>
        <div id="receivedError" class="error-text" style="display:none;"></div>
        <small class="text-muted">Enter the amount received from the consignee</small>
      </div>

      <!-- STATUS SELECT -->
      <label class="mb-2 fw-semibold">Delivery Status</label>
      <div class="status-options">
        <div class="status-option selected" data-status="delivered">
          <i class="fa-solid fa-circle-check" style="color:#00c600;"></i><div>Delivered</div>
        </div>
        <div class="status-option" data-status="cancelled">
          <i class="fa-solid fa-circle-xmark" style="color:#fd1d1d;"></i><div>Cancelled</div>
        </div>
      </div>
      <input type="hidden" id="deliveryStatus" value="delivered">

      <!-- NOTES -->
      <textarea id="deliveryNotes" rows="3" class="form-control mb-3" placeholder="Delivery notes"></textarea>

      <!-- IMAGE -->
      <div class="image-upload mb-2" id="imageUpload">
        <i class="fas fa-camera fa-2x"></i>
        <p>Tap to upload proof image</p>
      </div>

      <div class="existing-image text-center" style="display:none;">
        <img id="proofImage" alt="Proof">
      </div>

      <input type="file" id="imageInput" accept="image/*" style="display:none;">

    </form>
  </div>
</main>

<footer class="fixed-footer">
  <button id="saveButton" class="btn btn-lg w-100" style="display:none;">Save</button>
</footer>

<script>
const APP_ID = "Mzk-";
let proofImageSelected = false;
let currentOrderData = null;
let totalAmount = 0;

document.getElementById("backButton").addEventListener("click",()=>{ 
  window.location.href="delivery_status.html";
});

document.addEventListener("DOMContentLoaded",()=>{
  const notesInput = document.getElementById("deliveryNotes");
  const saveBtn = document.getElementById("saveButton");
  const imageInput = document.getElementById("imageInput");
  const errorNotes = document.createElement("div");
  const errorImage = document.createElement("div");

  // Insert message elements below fields
  errorNotes.style.color = "red";
  errorNotes.style.fontSize = "13px";
  errorNotes.style.marginTop = "4px";
  errorNotes.style.display = "none";
  notesInput.insertAdjacentElement("afterend", errorNotes);

  errorImage.style.color = "red";
  errorImage.style.fontSize = "13px";
  errorImage.style.textAlign = "center";
  errorImage.style.marginTop = "-10px";
  errorImage.style.display = "none";
  document.getElementById("imageUpload").insertAdjacentElement("afterend", errorImage);

  // Image upload handling
  document.getElementById("imageUpload").addEventListener("click",()=>imageInput.click());

  imageInput.addEventListener("change",()=> {
    if(imageInput.files.length > 0){
      proofImageSelected = true;
      const reader = new FileReader();
      reader.onload = e => {
        document.getElementById("proofImage").src = e.target.result;
        document.querySelector(".existing-image").style.display = "block";
      };
      reader.readAsDataURL(imageInput.files[0]);

      // Hide error once valid
      errorImage.style.display = "none";
      document.getElementById("imageUpload").style.borderColor = "#ddd";
    }
  });

  // Status option selection
  document.querySelectorAll('.status-option').forEach(option => {
    option.addEventListener('click', function() {
      document.querySelectorAll('.status-option').forEach(opt => opt.classList.remove('selected'));
      this.classList.add('selected');
      document.getElementById('deliveryStatus').value = this.dataset.status;
    });
  });

  // Save Button Validation
  saveBtn.addEventListener("click",()=>{

    let valid = true;

    // Notes validation
    if(notesInput.value.trim()===""){
      notesInput.style.borderColor = "red";
      errorNotes.textContent = "Notes required";
      errorNotes.style.display = "block";
      valid = false;
    } else {
      notesInput.style.borderColor = "#ccc";
      errorNotes.style.display = "none";
    }

    // Image validation
    if(!proofImageSelected){
      errorImage.textContent = "Proof image required";
      errorImage.style.display = "block";
      document.getElementById("imageUpload").style.borderColor = "red";
      valid = false;
    } else {
      errorImage.style.display = "none";
      document.getElementById("imageUpload").style.borderColor = "#ddd";
    }

    // Payment validation for "To Pay" orders
    const paymentTypeText = document.getElementById("paymentTypeDisplay").textContent.trim();
    const receivedError = document.getElementById("receivedError");
    receivedError.style.display = "none";
    receivedError.textContent = "";

    if (paymentTypeText === "To Pay") {
      const receivedStr = document.getElementById("receivedAmount").value;
      const received = parseFloat(receivedStr);

      if (!receivedStr || isNaN(received) || received <= 0) {
        receivedError.textContent = "Please enter a valid amount greater than 0";
        receivedError.style.display = "block";
        document.getElementById("receivedAmount").style.borderColor = "red";
        valid = false;
      } else if (received > totalAmount) {
        receivedError.textContent = "Received amount cannot be more than Total Amount";
        receivedError.style.display = "block";
        document.getElementById("receivedAmount").style.borderColor = "red";
        valid = false;
      } else {
        document.getElementById("receivedAmount").style.borderColor = "#ddd";
      }
    }

    if(valid){
      saveDeliveryStatus();
    }

  });

  // Load the selected order
  const orderId = localStorage.getItem("selectedOrderId");
  if(!orderId) return showError("No order selected");
  fetchOrderDetails(orderId);
});


function showForm(){
  document.getElementById("loadingSpinner").style.display="none";
  document.getElementById("deliveryForm").style.display="block";
  document.getElementById("saveButton").style.display="block";
}

function showError(msg){
  document.getElementById("loadingSpinner").style.display="none";
  document.getElementById("errorMessage").style.display="block";
  document.getElementById("errorText").textContent = msg;
}

// Format payment type (topay -> To Pay, etc.)
function formatPaymentType(v){
  if(!v) return "-";
  v = v.toLowerCase();
  if(v === "topay" || v === "to-pay" || v === "to pay") return "To Pay";
  if(v === "paidorder" || v === "paid_order" || v === "paid order") return "Paid Order";
  if(v === "none") return "None";
  return v.charAt(0).toUpperCase() + v.slice(1);
}

async function fetchOrderDetails(orderId){
  try{
    const res = await fetch("https://www.loginlogistics.in/main/driverapp/get_delivery_order_details.php",{
      method:"POST",
      headers:{ "Content-Type":"application/json"},
      body:JSON.stringify({ ord_id:orderId, app_id:APP_ID })
    });

    const data = await res.json();

    if(data.result === "1"){
      currentOrderData = data;
      
      document.getElementById("podDisplay").textContent = data.pod_no || "N/A";
      document.getElementById("paymentTypeDisplay").textContent = formatPaymentType(data.payment_type);

     // After setting the quantity fields from API
document.getElementById("smallBoxQty").value = data.box_small_qty || "0";
document.getElementById("mediumBoxQty").value = data.box_medium_qty || "0";
document.getElementById("largeBoxQty").value = data.box_large_qty || "0";
document.getElementById("smallCoverQty").value = data.cover_small_qty || "0";
document.getElementById("mediumCoverQty").value = data.cover_medium_qty || "0";
document.getElementById("largeCoverQty").value = data.cover_large_qty || "0";

// Set max = original quantity so cannot increase
["smallBoxQty","mediumBoxQty","largeBoxQty",
 "smallCoverQty","mediumCoverQty","largeCoverQty"].forEach(id=>{
  const input = document.getElementById(id);
  const original = parseInt(input.value) || 0;
  input.setAttribute("max", original);
  input.addEventListener("input", function(){
      let val = parseInt(input.value) || 0;
      if(val > original) input.value = original;   // restrict increase
      if(val < 0) input.value = 0;                // restrict negatives
  });
});

      // Total amount from API: "5,300.00"
      const totalRaw = data.total_amount || "0.00";
      document.getElementById("totalAmountDisplay").textContent = totalRaw;
      totalAmount = parseFloat(totalRaw.replace(/,/g,"")) || 0;

      // Show payment section only for To Pay
      const rawType = (data.payment_type || "").toLowerCase().replace(/\s+/g,"").replace(/-/g,"");
      if(rawType === "topay"){
        document.getElementById("paymentSection").style.display = "block";
      }

      showForm();
    } else {
      showError("Failed to load order details");
    }

  }catch(err){
    console.error(err);
    showError("Network error");
  }
}

async function saveDeliveryStatus() {
  try {
    const orderId = localStorage.getItem("selectedOrderId");
    const status = document.getElementById("deliveryStatus").value;
    const notes = document.getElementById("deliveryNotes").value;

    // Quantities
    const quantities = {
      box_small: document.getElementById("smallBoxQty").value || "0",
      box_medium: document.getElementById("mediumBoxQty").value || "0",
      box_large: document.getElementById("largeBoxQty").value || "0",
      cover_small: document.getElementById("smallCoverQty").value || "0",
      cover_medium: document.getElementById("mediumCoverQty").value || "0",
      cover_large: document.getElementById("largeCoverQty").value || "0"
    };

    const paymentTypeText = document.getElementById("paymentTypeDisplay").textContent.trim();
    let receivedAmount = "";

    if(paymentTypeText === "To Pay"){
      receivedAmount = document.getElementById("receivedAmount").value || "0";
    }

    const formData = new FormData();
    formData.append("ord_id", orderId);
    formData.append("status", status);
    formData.append("notes", notes);
    formData.append("app_id", APP_ID);

    Object.keys(quantities).forEach(key => {
      formData.append(key, quantities[key]);
    });

    if(paymentTypeText === "To Pay"){
      formData.append("received_amount", receivedAmount);
    }

    if (proofImageSelected) {
      formData.append("proof_image", document.getElementById("imageInput").files[0]);
    }

    const response = await fetch("https://www.loginlogistics.in/main/driverapp/update_delivery_status.php", {
      method: "POST",
      body: formData
    });

    const result = await response.json();

    if (result.success) {
      alert("Delivery status updated successfully!");
      window.location.href = "delivery_status.html";
    } else {
      alert("Failed to update delivery status: " + (result.message || "Unknown error"));
    }

  } catch (error) {
    console.error("Error saving delivery status:", error);
    alert("Error saving delivery status. Please try again.");
  }
}
</script>

</body>
</html>
